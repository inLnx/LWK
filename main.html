<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        :root {
            --background-color: #15202B;
            --primary-text-color: #F7F9F9;
            --secondary-text-color: #8899A6;
            --accent-color: #1D9BF0;
            --border-color: #38444D;
            --container-background: #192734;
            --hover-background: rgba(29, 155, 240, 0.1);
            --like-color: #F91880;
        }
        html, body {
            background-color: var(--background-color);
            color: var(--primary-text-color);
            font-family: 'Inter', sans-serif;
            overflow-y: scroll;
        }
        #loading-bar {
            position: fixed; top: 0; left: 0; height: 3px;
            background-color: var(--accent-color); width: 0%; z-index: 9999;
            transition: width 0.4s ease-out, opacity 0.5s ease 0.5s;
        }
        .main-app-container { display: flex; justify-content: center; width: 100%; max-width: 1265px; margin: 0 auto; gap: 20px; }
        .left-sidebar { width: 275px; height: 100vh; position: sticky; top: 0; display: flex; flex-direction: column; padding: 10px 0; }
        .sidebar-link { display: flex; align-items: center; gap: 20px; padding: 12px; border-radius: 9999px; cursor: pointer; transition: background-color 0.2s ease; font-size: 20px; font-weight: 500; color: var(--secondary-text-color); text-decoration: none; }
        .sidebar-link:hover { background-color: var(--hover-background); color: var(--primary-text-color); }
        .sidebar-link.active { font-weight: 700; color: var(--primary-text-color); }
        .user-profile-widget { margin-top: auto; display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 9999px; cursor: pointer; transition: background-color 0.2s; }
        .user-profile-widget:hover { background-color: var(--hover-background); }
        .user-profile-widget img { width: 40px; height: 40px; border-radius: 50%; }
        
        .main-feed { width: 600px; min-height: 100vh; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); }
        .page-container { display: none; }
        .page-container.active { display: block; }
        .page-header { position: sticky; top: 0; background-color: rgba(21, 32, 43, 0.85); backdrop-filter: blur(12px); z-index: 10; padding: 16px; font-size: 20px; font-weight: 700; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 20px; }
        .back-button { cursor: pointer; font-size: 24px; padding: 4px; }
        
        /* Post Composer */
        .post-composer { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; gap: 12px; }
        .post-composer-main { flex-grow: 1; position: relative; }
        .post-composer-textarea { width: 100%; background: transparent; border: none; outline: none; color: var(--primary-text-color); font-size: 20px; resize: none; padding: 12px 0; min-height: 60px; }
        .composer-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .composer-inputs { display: flex; flex-direction: column; gap: 8px; border-top: 1px solid var(--border-color); padding-top: 12px;}
        .composer-input { width: 100%; background-color: var(--background-color); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: 6px; padding: 8px 12px; font-size: 15px; }
        .composer-button-post { background-color: var(--accent-color); color: white; font-weight: 700; border-radius: 9999px; padding: 8px 16px; cursor: pointer; opacity: 0.5; transition: all 0.2s ease; }
        .composer-button-post.enabled { opacity: 1; }

        /* Profile Page */
        .profile-header { position: relative; }
        .profile-banner { height: 200px; background-color: var(--border-color); }
        .profile-banner img { width: 100%; height: 100%; object-fit: cover; }
        .profile-pfp { position: absolute; left: 16px; bottom: -70px; width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--background-color); }
        .profile-details { padding: 85px 16px 16px 16px; border-bottom: 1px solid var(--border-color); }
        .profile-actions { display: flex; justify-content: flex-end; padding-top: 12px; }
        .dm-button { background: none; border: 1px solid var(--primary-text-color); color: var(--primary-text-color); padding: 8px 16px; border-radius: 9999px; font-weight: 700; cursor: pointer; }
        
        .post-card { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
        .post-card .pfp { width: 48px; height: 48px; border-radius: 50%; }
        .post-content .mention { color: var(--accent-color); font-weight: 500; text-decoration: none; }
        .post-content .mention:hover { text-decoration: underline; }
        .post-map-container { height: 280px; width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border-color); overflow: hidden; z-index: 1; }
        .action-item { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
        .action-item.like.liked { color: var(--like-color); }
        .action-item.like:hover { color: var(--like-color); }

        #mentions-popup { display: none; position: absolute; top: 90px; left: 0; width: 100%; max-height: 250px; overflow-y: auto; background-color: var(--container-background); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 100; }
        .mention-item { display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; }
        .mention-item:hover { background-color: var(--hover-background); }
        .mention-item img { width: 40px; height: 40px; border-radius: 50%; }

        .page-content-wrapper { padding: 16px; }
        .page-content-wrapper textarea, .page-content-wrapper input { background-color: var(--container-background); border: 1px solid var(--border-color); color: var(--primary-text-color); padding: 12px; border-radius: 6px; width: 100%; margin-top: 12px; }
        .page-content-wrapper .action-button { width: 100%; background-color: var(--accent-color); color: white; padding: 10px 20px; border: none; border-radius: 9999px; cursor: pointer; margin-top: 15px; font-weight: 700; }
        
        .profile-list-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
        .profile-list-item img { width: 48px; height: 48px; border-radius: 50%; }
    </style>
</head>
<body>
    <div id="loading-bar"></div>

    <div class="main-app-container">
        <nav class="left-sidebar">
            <a href="#home" class="sidebar-link">üè†<span>Home</span></a>
            <a href="#ai-post" class="sidebar-link">‚ú®<span>AI Post</span></a>
            <a href="#profiles" class="sidebar-link">üåê<span>Nearby Profiles</span></a>
            <div id="user-profile-widget" class="user-profile-widget">
                 <img id="user-pfp-widget" src="https://placehold.co/40x40/15202B/8899A6?text=üë§" alt="User PFP">
                 <div class="flex flex-col"><span id="user-name-widget" class="name">Guest</span><span id="user-handle-widget" class="handle">@guest</span></div>
            </div>
        </nav>

        <main id="main-feed-container" class="main-feed">
            <div id="home-page" class="page-container">
                <div class="page-header">Home</div>
                <div class="post-composer">
                    <img id="composer-pfp" src="https://placehold.co/48x48/15202B/8899A6?text=üë§" alt="Your PFP">
                    <div class="post-composer-main">
                        <textarea id="post-composer-textarea" class="post-composer-textarea" placeholder="What's happening?"></textarea>
                        <div id="mentions-popup"></div>
                        <div class="composer-inputs">
                             <input type="url" id="post-link-composer" class="composer-input" placeholder="Optional: Add a link">
                             <input type="text" id="post-location-composer" class="composer-input" placeholder="Optional: Tag a location (e.g., 'Eiffel Tower')">
                        </div>
                        <div class="composer-actions">
                            <div></div>
                            <button id="composer-post-btn" class="composer-button-post">Post</button>
                        </div>
                    </div>
                </div>
                <div id="posts-container"></div>
                <p id="no-posts-message" class="text-center p-8 text-gray-500">No posts nearby</p>
            </div>
            
            <div id="ai-post-page" class="page-container">
                 <div class="page-header">Generate Post with AI</div>
                 <div class="page-content-wrapper">
                    <textarea id="ai-prompt-input" rows="3" placeholder="Enter topic or prompt for AI..."></textarea>
                    <button id="generate-ai-post-btn" class="action-button">Generate Post</button>
                    <textarea id="ai-generated-content" rows="6" readonly class="mt-4 bg-gray-800" placeholder="Generated content will appear here..."></textarea>
                    <button id="use-ai-post-btn" class="action-button">Use This Post & Go Home</button>
                 </div>
            </div>

            <div id="profiles-page" class="page-container">
                <div class="page-header">Nearby Profiles</div>
                <div id="profiles-list-container"></div>
            </div>

            <div id="profile-page" class="page-container"></div>
        </main>
        
        <aside class="w-[350px]"></aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, doc, setDoc, getDoc, runTransaction, increment, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyAE37qdlDBYSUhumSO6jTA985V81DN9iA8", authDomain: "lowk-be8e0.firebaseapp.com", projectId: "lowk-be8e0", storageBucket: "lowk-be8e0.firebasestorage.app", messagingSenderId: "244867743683", appId: "1:244867743683:web:1b11ac7b94462ef5314776" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let app, db, auth, currentUserId = null, userLocation = null;
        const userProfilesCache = {};
        let allUsersForMentions = [];
        let mainFeedUnsubscribe = null;

        const loadingBar = document.getElementById('loading-bar');
        const showLoadingBar = () => { loadingBar.style.opacity = '1'; loadingBar.style.width = '90%'; };
        const hideLoadingBar = () => { loadingBar.style.width = '100%'; setTimeout(() => { loadingBar.style.opacity = '0'; }, 500); };
        
        const mainFeedContainer = document.getElementById('main-feed-container');
        const postsContainer = document.getElementById('posts-container');
        const postComposerTextarea = document.getElementById('post-composer-textarea');
        const composerPostBtn = document.getElementById('composer-post-btn');
        const postLinkComposer = document.getElementById('post-link-composer');
        const postLocationComposer = document.getElementById('post-location-composer');
        const mentionsPopup = document.getElementById('mentions-popup');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const generateAiPostBtn = document.getElementById('generate-ai-post-btn');
        const aiGeneratedContent = document.getElementById('ai-generated-content');
        const useAiPostBtn = document.getElementById('use-ai-post-btn');
        const profilesListContainer = document.getElementById('profiles-list-container');
        
        const generateHandle = (displayName, uid) => uid ? `@${(displayName || 'user').toLowerCase().replace(/\s+/g, '')}_${uid.substring(0,4)}` : '@guest';
        const parseAndRenderMentions = (text) => text ? text.replace(/@\w+_\w{4}/g, match => `<a href="#" class="mention">${match}</a>`).replace(/\n/g, '<br>') : '';
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; const œÜ1 = lat1 * Math.PI / 180; const œÜ2 = lat2 * Math.PI / 180; const ŒîœÜ = (lat2 - lat1) * Math.PI / 180; const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };
        const geocodeLocation = async (address) => {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
            try {
                const response = await fetch(url); if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json(); if (data && data.length > 0) return { latitude: parseFloat(data[0].lat), longitude: parseFloat(data[0].lon) };
                return null;
            } catch (error) { console.error('Geocoding failed:', error); return null; }
        };

        async function getUserProfile(userId) { /* Unchanged */ }
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) await signOut(auth);
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                await setDoc(userDocRef, { uid: user.uid, displayName: user.displayName, photoURL: user.photoURL, email: user.email }, { merge: true });
            } catch (error) { if (!auth.currentUser) await signInAnonymously(auth); }
        }
        
        async function handleSignOut() { await signOut(auth); await signInAnonymously(auth); }

        async function toggleLike(postId) {
            if (!currentUserId) { alert("Please sign in to like posts."); return; }
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            await runTransaction(db, async (t) => {
                const postDoc = await t.get(postRef); if (!postDoc.exists()) throw "Post not found!";
                const likes = postDoc.data().likes || [];
                if (likes.includes(currentUserId)) t.update(postRef, { likes: arrayRemove(currentUserId), likeCount: increment(-1) });
                else t.update(postRef, { likes: arrayUnion(currentUserId), likeCount: increment(1) });
            });
        }

        function createPostCard(post) {
            const authorProfile = userProfilesCache[post.userId] || {};
            const authorName = authorProfile.displayName || "Unknown";
            const authorPfp = authorProfile.photoURL || `https://ui-avatars.com/api/?name=${authorName}`;
            const isLiked = post.likes?.includes(currentUserId);
            const card = document.createElement('article');
            card.className = 'post-card';
            card.innerHTML = `
                <a href="#profile/${post.userId}"><img src="${authorPfp}" alt="PFP" class="pfp"></a>
                <div class="post-main">
                    <div class="post-header"><a href="#profile/${post.userId}" class="font-bold hover:underline">${authorName}</a><span class="text-gray-500 ml-2">${generateHandle(authorName, post.userId)}</span></div>
                    <div class="post-content">${parseAndRenderMentions(post.text)}</div>
                    ${post.customLocation ? `<div id="map-${post.id}" class="post-map-container"></div>` : ''}
                    <div class="post-actions">
                        <div class="action-item like ${isLiked ? 'liked' : ''}" data-post-id="${post.id}"><span class="icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span><span>${post.likeCount || 0}</span></div>
                    </div>
                </div>`;
            if(post.customLocation) { setTimeout(() => { if (document.getElementById(`map-${post.id}`) && !document.getElementById(`map-${post.id}`)._leaflet_id) { const map = L.map(`map-${post.id}`).setView([post.customLocation.latitude, post.customLocation.longitude], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); L.marker([post.customLocation.latitude, post.customLocation.longitude]).addTo(map); } }, 0); }
            return card;
        }

        function setupMainFeedListener() {
            if (mainFeedUnsubscribe) mainFeedUnsubscribe();
            if (!userLocation) { document.getElementById('no-posts-message').textContent = "Location not available."; return; }
            const postsQuery = query(collection(db, `artifacts/${appId}/public/data/posts`), orderBy("timestamp", "desc"));
            mainFeedUnsubscribe = onSnapshot(postsQuery, async (snapshot) => {
                const allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const nearbyPosts = allPosts.filter(post => post.location && calculateDistance(userLocation.latitude, userLocation.longitude, post.location.latitude, post.location.longitude) <= 500);
                postsContainer.innerHTML = '';
                document.getElementById('no-posts-message').style.display = nearbyPosts.length > 0 ? 'none' : 'block';
                if (nearbyPosts.length === 0) return;
                const userIds = [...new Set(nearbyPosts.map(p => p.userId))];
                await Promise.all(userIds.map(id => getUserProfile(id)));
                nearbyPosts.forEach(post => postsContainer.appendChild(createPostCard(post)));
            });
        }
        
        async function renderUserProfilePage(userId) { /* Unchanged */ }
        
        async function fetchAndDisplayProfiles() {
            profilesListContainer.innerHTML = `<p class="text-center p-8 text-gray-500">Loading profiles...</p>`;
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const snapshot = await getDocs(query(usersRef));
            profilesListContainer.innerHTML = '';
            if (snapshot.empty) { profilesListContainer.innerHTML = `<p class="text-center p-8 text-gray-500">No profiles found.</p>`; return; }
            snapshot.forEach(doc => {
                const user = doc.data();
                if (user.isAnonymous || !user.displayName) return;
                const profileItem = document.createElement('a');
                profileItem.href = `#profile/${user.uid}`;
                profileItem.className = 'profile-list-item';
                profileItem.innerHTML = `<img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`}" alt="PFP"><div><div class="font-bold">${user.displayName}</div><div class="text-sm text-gray-500">${generateHandle(user.displayName, user.uid)}</div></div>`;
                profilesListContainer.appendChild(profileItem);
            });
        }
        
        async function fetchAllUsersForMentions() { /* Unchanged */ }
        function showMentionsPopup(users, text, mentionStartPos) { /* Unchanged */ }
        function hideMentionsPopup() { /* Unchanged */ }
        function handleMentionInput(event) { /* Unchanged */ }
        
        async function handlePostSubmit() {
            const text = postComposerTextarea.value.trim();
            if (!text || !currentUserId || !userLocation) { alert("Cannot post. Ensure you are signed in and location is enabled."); return; }
            composerPostBtn.disabled = true; composerPostBtn.textContent = 'Posting...';
            try {
                const customLocation = postLocationComposer.value.trim() ? await geocodeLocation(postLocationComposer.value.trim()) : null;
                const postData = { userId: currentUserId, text, timestamp: Date.now(), location: userLocation, likeCount: 0, likes: [] };
                if (postLinkComposer.value.trim()) postData.linkUrl = postLinkComposer.value.trim();
                if (customLocation) postData.customLocation = customLocation;
                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), postData);
                postComposerTextarea.value = ''; postLinkComposer.value = ''; postLocationComposer.value = '';
                postComposerTextarea.dispatchEvent(new Event('input'));
            } catch (error) { alert(`Failed to post: ${error.message}`); } 
            finally { composerPostBtn.disabled = false; composerPostBtn.textContent = 'Post'; }
        }

        function router() {
            if (mainFeedUnsubscribe) { mainFeedUnsubscribe(); mainFeedUnsubscribe = null; }
            const hash = window.location.hash || '#home';
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const targetLink = document.querySelector(`.sidebar-link[href="${hash.split('/')[0]}"]`);
            if(targetLink) targetLink.classList.add('active');

            if (hash.startsWith('#profile/')) {
                const userId = hash.split('/')[1];
                document.getElementById('profile-page').classList.add('active');
                if (userId) renderUserProfilePage(userId);
            } else if (hash === '#ai-post') {
                document.getElementById('ai-post-page').classList.add('active');
            } else if (hash === '#profiles') {
                document.getElementById('profiles-page').classList.add('active');
                fetchAndDisplayProfiles();
            } else {
                document.getElementById('home-page').classList.add('active');
                setupMainFeedListener();
            }
        }

        async function initializeAppLogic() {
            showLoadingBar();
            app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
            if (!auth.currentUser) await signInAnonymously(auth);
            
            await fetchAllUsersForMentions();
            
            onAuthStateChanged(auth, async (user) => {
                currentUserId = user?.isAnonymous ? null : user?.uid;
                try {
                    userLocation = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(pos => resolve({latitude: pos.coords.latitude, longitude: pos.coords.longitude}), err => reject(new Error("Location access denied."))));
                } catch (e) { console.error(e.message); } 
                finally {
                    router(); hideLoadingBar();
                }
            });

            mainFeedContainer.addEventListener('click', e => {
                const likeBtn = e.target.closest('.action-item.like');
                const dmBtn = e.target.closest('.dm-button');
                const backBtn = e.target.closest('.back-button');
                if (likeBtn) toggleLike(likeBtn.dataset.postId);
                if (dmBtn) { if (currentUserId) alert(`DM feature coming soon!`); else alert("Please sign in to send messages."); }
                if (backBtn) window.history.back();
            });
            
            postComposerTextarea.addEventListener('input', (e) => { composerPostBtn.classList.toggle('enabled', postComposerTextarea.value.trim().length > 0); handleMentionInput(e); });
            composerPostBtn.addEventListener('click', () => { if (composerPostBtn.classList.contains('enabled')) handlePostSubmit(); });
            useAiPostBtn.addEventListener('click', () => { if (aiGeneratedContent.value.trim()) { postComposerTextarea.value = aiGeneratedContent.value.trim(); postComposerTextarea.dispatchEvent(new Event('input')); window.location.hash = '#home'; } });
            document.addEventListener('click', (e) => { if (!mentionsPopup.contains(e.target) && e.target !== postComposerTextarea) hideMentionsPopup(); });

            window.addEventListener('hashchange', router);
        }
        
        initializeAppLogic();
    </script>
</body>
</html>