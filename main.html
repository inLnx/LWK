<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --background-color: #15202B;
            --primary-text-color: #F7F9F9;
            --secondary-text-color: #8899A6;
            --accent-color: #1D9BF0;
            --border-color: #38444D;
            --container-background: #192734;
            --hover-background: rgba(29, 155, 240, 0.1);
            --like-color: #F91880;
        }
        html, body {
            background-color: var(--background-color);
            color: var(--primary-text-color);
            font-family: 'Inter', sans-serif;
            overflow-y: scroll;
        }
        .main-app-container {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 1265px;
            margin: 0 auto;
            gap: 20px;
        }
        .left-sidebar {
            width: 275px;
            height: 100vh;
            position: sticky;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 10px 0;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 20px;
            font-weight: 500;
            color: var(--secondary-text-color);
            text-decoration: none;
        }
        .sidebar-link:hover {
            background-color: var(--hover-background);
            color: var(--primary-text-color);
        }
        .sidebar-link.active {
            font-weight: 700;
            color: var(--primary-text-color);
        }
        .sidebar-link .icon { font-size: 26px; }
        .sidebar-button-post {
            background-color: var(--accent-color);
            color: white;
            font-size: 17px;
            font-weight: 700;
            border-radius: 9999px;
            padding: 15px 0;
            text-align: center;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.2s ease;
        }
        .sidebar-button-post:hover { background-color: #1A8CD8; }
        .user-profile-widget {
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .user-profile-widget:hover { background-color: var(--hover-background); }
        .user-profile-widget img { width: 40px; height: 40px; border-radius: 50%; }
        .user-profile-widget .name { font-weight: 700; }
        .user-profile-widget .handle { color: var(--secondary-text-color); }

        /* Main Feed Column */
        .main-feed {
            width: 600px;
            min-height: 100vh;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        /* Page Container within Main Feed */
        .page-container { display: none; }
        .page-container.active { display: block; }
        .page-header {
            position: sticky;
            top: 0;
            background-color: rgba(21, 32, 43, 0.85);
            backdrop-filter: blur(12px);
            z-index: 10;
            padding: 16px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Home Page: Post Composer */
        .post-composer {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }
        .post-composer img { width: 48px; height: 48px; border-radius: 50%; }
        .post-composer-main { flex-grow: 1; }
        .post-composer-textarea {
            width: 100%; background: transparent; border: none; outline: none;
            color: var(--primary-text-color); font-size: 20px; resize: none;
            padding: 12px 0; min-height: 60px;
        }
        .post-composer-textarea::placeholder { color: var(--secondary-text-color); }
        .composer-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .composer-inputs { display: flex; flex-direction: column; gap: 8px; border-top: 1px solid var(--border-color); padding-top: 12px;}
        .composer-input {
             width: 100%; background-color: var(--background-color); border: 1px solid var(--border-color);
             color: var(--primary-text-color); border-radius: 6px; padding: 8px 12px; font-size: 15px;
        }
        .composer-button-post {
            background-color: var(--accent-color); color: white; font-weight: 700; border-radius: 9999px;
            padding: 8px 16px; cursor: pointer; opacity: 0.5; transition: all 0.2s ease;
        }
        .composer-button-post.enabled { opacity: 1; }
        .composer-button-post.enabled:hover { background-color: #1A8CD8; }

        /* Home Page: Post Card (Tweet) */
        .post-card { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; }
        .post-card:hover { background-color: rgba(255, 255, 255, 0.03); }
        .post-card .pfp { width: 48px; height: 48px; border-radius: 50%; }
        .post-main { flex-grow: 1; }
        .post-header { display: flex; align-items: center; gap: 4px; }
        .post-header .name { font-weight: 700; }
        .post-header .verified-badge { color: var(--accent-color); font-size: 14px; }
        .post-header .handle, .post-header .timestamp { color: var(--secondary-text-color); }
        .post-content { margin-top: 4px; white-space: pre-wrap; word-wrap: break-word; }
        .post-map-container { height: 280px; width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border-color); overflow: hidden; z-index: 1; }
        .post-actions { display: flex; justify-content: space-around; margin-top: 12px; color: var(--secondary-text-color); }
        .action-item { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
        .action-item .icon { font-size: 18px; padding: 8px; border-radius: 50%; transition: all 0.2s; }
        .action-item:hover .icon { background-color: var(--hover-background); }
        .action-item:hover { color: var(--accent-color); }
        .action-item.like.liked { color: var(--like-color); }
        .action-item.like:hover { color: var(--like-color); }
        .action-item.like:hover .icon { background-color: rgba(249, 24, 128, 0.1); }
        
        /* AI & Profiles Page Specific Styles */
        .page-content-wrapper { padding: 16px; }
        .page-content-wrapper textarea, .page-content-wrapper input {
            background-color: var(--container-background); border: 1px solid var(--border-color);
            color: var(--primary-text-color); padding: 12px; border-radius: 6px; width: 100%; margin-top: 12px;
        }
        .page-content-wrapper textarea:focus, .page-content-wrapper input:focus { outline: none; border-color: var(--accent-color); }
        .page-content-wrapper .action-button {
            width: 100%; background-color: var(--accent-color); color: white;
            padding: 10px 20px; border: none; border-radius: 9999px; cursor: pointer;
            margin-top: 15px; font-weight: 700;
        }
        .profile-list-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .profile-list-item img { width: 48px; height: 48px; border-radius: 50%; }
    </style>
</head>
<body>
    
    <div class="main-app-container">
        <!-- Left Sidebar -->
        <nav class="left-sidebar">
            <a href="#home" class="sidebar-link">
                <span class="icon">üè†</span><span class="text">Home</span>
            </a>
            <a href="#ai-post" class="sidebar-link">
                <span class="icon">‚ú®</span><span class="text">AI Post</span>
            </a>
            <a href="#profiles" class="sidebar-link">
                <span class="icon">üåê</span><span class="text">Nearby Profiles</span>
            </a>
            <a href="#" id="enable-notifs-btn" class="sidebar-link">
                <span class="icon">üîî</span><span class="text">Notifications</span>
            </a>
            <div class="sidebar-button-post">Post</div>

            <div id="user-profile-widget" class="user-profile-widget">
                 <img id="user-pfp-widget" src="https://placehold.co/40x40/15202B/8899A6?text=üë§" alt="User PFP">
                 <div class="flex flex-col">
                    <span id="user-name-widget" class="name">Guest</span>
                    <span id="user-handle-widget" class="handle">@guest</span>
                 </div>
            </div>
        </nav>

        <!-- Main Feed Column -->
        <main class="main-feed">
            <!-- Page: Home -->
            <div id="home-page" class="page-container">
                <div class="page-header">Home</div>
                <div class="post-composer">
                    <img id="composer-pfp" src="https://placehold.co/48x48/15202B/8899A6?text=üë§" alt="Your PFP">
                    <div class="post-composer-main">
                        <textarea id="post-composer-textarea" class="post-composer-textarea" placeholder="What's happening?"></textarea>
                        <div class="composer-inputs">
                             <input type="url" id="post-link-composer" class="composer-input" placeholder="Optional: Add a link">
                             <input type="text" id="post-location-composer" class="composer-input" placeholder="Optional: Tag a location (e.g., 'Eiffel Tower')">
                        </div>
                        <div class="composer-actions">
                            <div></div>
                            <button id="composer-post-btn" class="composer-button-post">Post</button>
                        </div>
                    </div>
                </div>
                <div id="posts-container"></div>
                <p id="no-posts-message" class="text-center p-8 text-gray-500">No posts nearby</p>
            </div>

            <!-- Page: AI Post -->
            <div id="ai-post-page" class="page-container">
                 <div class="page-header">Generate Post with AI</div>
                 <div class="page-content-wrapper">
                    <textarea id="ai-prompt-input" rows="3" placeholder="Enter topic or prompt for AI..."></textarea>
                    <button id="generate-ai-post-btn" class="action-button">Generate Post</button>
                    <textarea id="ai-generated-content" rows="6" readonly class="mt-4 bg-gray-800" placeholder="Generated content will appear here..."></textarea>
                    <button id="use-ai-post-btn" class="action-button">Use This Post & Go Home</button>
                 </div>
            </div>

            <!-- Page: Nearby Profiles -->
            <div id="profiles-page" class="page-container">
                <div class="page-header">Nearby Profiles</div>
                <div id="profiles-list-container">
                    <p class="text-center p-8 text-gray-500">Loading profiles...</p>
                </div>
            </div>

        </main>
        
        <!-- Right Sidebar (Placeholder) -->
        <aside class="w-[350px]"></aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, doc, setDoc, getDoc, runTransaction, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Config and Variables ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyAE37qdlDBYSUhumSO6jTA985V81DN9iA8", authDomain: "lowk-be8e0.firebaseapp.com", projectId: "lowk-be8e0", storageBucket: "lowk-be8e0.firebasestorage.app", messagingSenderId: "244867743683", appId: "1:244867743683:web:1b11ac7b94462ef5314776" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth, currentUserId = null, userLocation = null;
        const userProfilesCache = {};

        // --- UI Element Selectors ---
        const userProfileWidget = document.getElementById('user-profile-widget');
        const userNameWidget = document.getElementById('user-name-widget');
        const userHandleWidget = document.getElementById('user-handle-widget');
        const userPfpWidget = document.getElementById('user-pfp-widget');
        const composerPfp = document.getElementById('composer-pfp');

        const postComposerTextarea = document.getElementById('post-composer-textarea');
        const postLinkComposer = document.getElementById('post-link-composer');
        const postLocationComposer = document.getElementById('post-location-composer');
        const composerPostBtn = document.getElementById('composer-post-btn');
        
        const postsContainer = document.getElementById('posts-container');
        const noPostsMessage = document.getElementById('no-posts-message');
        
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const generateAiPostBtn = document.getElementById('generate-ai-post-btn');
        const aiGeneratedContent = document.getElementById('ai-generated-content');
        const useAiPostBtn = document.getElementById('use-ai-post-btn');
        const profilesListContainer = document.getElementById('profiles-list-container');
        const enableNotifsBtn = document.getElementById('enable-notifs-btn');

        // --- Helper Functions ---
        const showMessageBox = (message) => { alert(message); };
        const generateHandle = (displayName, uid) => {
            if (!displayName || displayName === "Guest" || !uid) return `@guest`;
            return `@${displayName.toLowerCase().replace(/\s+/g, '')}_${uid.substring(0,4)}`;
        };
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; const œÜ1 = lat1 * Math.PI / 180; const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180; const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };
        const geocodeLocation = async (address) => {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                if (data && data.length > 0) return { latitude: parseFloat(data[0].lat), longitude: parseFloat(data[0].lon) };
                return null;
            } catch (error) { console.error('Geocoding failed:', error); return null; }
        };

        // --- Core Application Logic ---
        
        async function getUserProfile(userId) {
            if (userProfilesCache[userId]) return userProfilesCache[userId];
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    userProfilesCache[userId] = userDocSnap.data();
                    return userProfilesCache[userId];
                }
                return { uid: userId, displayName: "Unknown User", photoURL: "" };
            } catch (error) {
                return { uid: userId, displayName: "Error User", photoURL: "" };
            }
        }
        
        function updateUserUI(user) {
            const isGuest = !user || user.isAnonymous;
            currentUserId = isGuest ? null : user.uid;
            const displayName = isGuest ? "Guest" : (user.displayName || "User");
            const photoURL = isGuest ? "https://placehold.co/48x48/15202B/8899A6?text=üë§" : (user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=1D9BF0&color=F7F9F9`);

            userNameWidget.textContent = displayName;
            userHandleWidget.textContent = generateHandle(displayName, user?.uid);
            userPfpWidget.src = photoURL;
            composerPfp.src = photoURL;
            
            userProfileWidget.onclick = isGuest ? handleGoogleSignIn : handleSignOut;
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) await signOut(auth);
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                await setDoc(userDocRef, { uid: user.uid, displayName: user.displayName, photoURL: user.photoURL, email: user.email }, { merge: true });
            } catch (error) {
                console.error("Google Sign-in Error:", error);
                if (!auth.currentUser) await signInAnonymously(auth);
            }
        }
        
        async function handleSignOut() {
            await signOut(auth);
            await signInAnonymously(auth);
        }

        async function displayPosts(postsData) {
            const nearbyPosts = postsData.filter(post => {
                if (!userLocation || !post.location) return false;
                return calculateDistance(userLocation.latitude, userLocation.longitude, post.location.latitude, post.location.longitude) <= 500;
            });
            
            noPostsMessage.style.display = nearbyPosts.length > 0 ? 'none' : 'block';
            postsContainer.innerHTML = '';
            if (nearbyPosts.length === 0) return;

            const userIdsToFetch = [...new Set(nearbyPosts.map(p => p.userId))];
            await Promise.all(userIdsToFetch.filter(id => !userProfilesCache[id]).map(id => getUserProfile(id)));

            for (const post of nearbyPosts) {
                const authorProfile = userProfilesCache[post.userId] || {};
                const authorName = authorProfile.displayName || "Unknown";
                const authorPfp = authorProfile.photoURL || `https://ui-avatars.com/api/?name=${authorName}&background=1D9BF0&color=F7F9F9`;
                const isLiked = post.likes && post.likes.includes(currentUserId);
                
                const card = document.createElement('article');
                card.className = 'post-card';
                card.innerHTML = `
                    <img src="${authorPfp}" alt="PFP" class="pfp">
                    <div class="post-main">
                        <div class="post-header">
                            <span class="name">${authorName}</span>
                            ${!authorProfile.isAnonymous && authorProfile.email ? '<span class="verified-badge">‚úî</span>' : ''}
                            <span class="handle">${generateHandle(authorName, post.userId)}</span>
                            <span class="handle">¬∑</span>
                            <span class="timestamp">${new Date(post.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="post-content">${post.text.replace(/\n/g, '<br>')}</div>
                        ${post.customLocation ? `<div id="map-${post.id}" class="post-map-container"></div>` : ''}
                        <div class="post-actions">
                            <div class="action-item reply"><span class="icon">üí¨</span><span>0</span></div>
                            <div class="action-item retweet"><span class="icon">üîÑ</span><span>0</span></div>
                            <div class="action-item like ${isLiked ? 'liked' : ''}" data-post-id="${post.id}">
                                <span class="icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span class="like-count">${post.likeCount || 0}</span>
                            </div>
                            <div class="action-item share"><span class="icon">üì§</span></div>
                        </div>
                    </div>
                `;
                postsContainer.appendChild(card);
            }

            // Initialize maps after rendering
            for (const post of nearbyPosts) {
                if (post.customLocation) {
                    const mapId = `map-${post.id}`;
                    if (document.getElementById(mapId) && !document.getElementById(mapId)._leaflet_id) {
                        const map = L.map(mapId).setView([post.customLocation.latitude, post.customLocation.longitude], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                        L.marker([post.customLocation.latitude, post.customLocation.longitude]).addTo(map);
                    }
                }
            }
        }

        async function handlePostSubmit() {
            const text = postComposerTextarea.value.trim();
            if (!text || !currentUserId || auth.currentUser.isAnonymous || !userLocation) {
                showMessageBox("Cannot post. Ensure you are signed in and location is enabled.");
                return;
            }
            composerPostBtn.disabled = true;
            composerPostBtn.textContent = 'Posting...';
            try {
                const customLocation = postLocationComposer.value.trim() ? await geocodeLocation(postLocationComposer.value.trim()) : null;
                const postData = { userId: currentUserId, text, timestamp: Date.now(), location: userLocation, likeCount: 0, likes: [] };
                if (postLinkComposer.value.trim()) postData.linkUrl = postLinkComposer.value.trim();
                if (customLocation) postData.customLocation = customLocation;
                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), postData);
                postComposerTextarea.value = ''; postLinkComposer.value = ''; postLocationComposer.value = '';
                postComposerTextarea.dispatchEvent(new Event('input'));
            } catch (error) { showMessageBox(`Failed to post: ${error.message}`); } 
            finally { composerPostBtn.disabled = false; composerPostBtn.textContent = 'Post'; }
        }
        
        async function toggleLike(postId) {
            if (!currentUserId || auth.currentUser.isAnonymous) {
                showMessageBox("Please sign in to like posts."); return;
            }
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            await runTransaction(db, async (t) => {
                const postDoc = await t.get(postRef);
                if (!postDoc.exists()) throw "Post not found!";
                const likes = postDoc.data().likes || [];
                if (likes.includes(currentUserId)) t.update(postRef, { likes: arrayRemove(currentUserId), likeCount: increment(-1) });
                else t.update(postRef, { likes: arrayUnion(currentUserId), likeCount: increment(1) });
            });
        }
        
        async function fetchAndDisplayProfiles() {
            profilesListContainer.innerHTML = `<p class="text-center p-8 text-gray-500">Loading profiles...</p>`;
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const snapshot = await getDocs(query(usersRef));
            profilesListContainer.innerHTML = '';
            if (snapshot.empty) {
                profilesListContainer.innerHTML = `<p class="text-center p-8 text-gray-500">No profiles found.</p>`;
                return;
            }
            snapshot.forEach(doc => {
                const user = doc.data();
                if (user.isAnonymous || !user.displayName) return;
                const profileItem = document.createElement('div');
                profileItem.className = 'profile-list-item';
                profileItem.innerHTML = `
                    <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`}" alt="PFP">
                    <div>
                        <div class="font-bold">${user.displayName}</div>
                        <div class="text-sm text-gray-500">${generateHandle(user.displayName, user.uid)}</div>
                    </div>
                `;
                profilesListContainer.appendChild(profileItem);
            });
        }

        // --- Router ---
        function router() {
            const hash = window.location.hash || '#home';
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            
            const targetPage = document.querySelector(hash + '-page');
            const targetLink = document.querySelector(`.sidebar-link[href="${hash}"]`);

            if (targetPage) targetPage.classList.add('active');
            else document.querySelector('#home-page').classList.add('active'); // Fallback
            
            if (targetLink) targetLink.classList.add('active');
            else document.querySelector('.sidebar-link[href="#home"]').classList.add('active'); // Fallback

            // Page-specific actions
            if (hash === '#profiles') {
                fetchAndDisplayProfiles();
            }
        }

        // --- Initialization ---
        async function initializeAppLogic() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken).catch(console.warn);
            else if (!auth.currentUser) await signInAnonymously(auth);

            onAuthStateChanged(auth, async (user) => {
                updateUserUI(user);
                try {
                    userLocation = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(pos => resolve({latitude: pos.coords.latitude, longitude: pos.coords.longitude}), err => reject(err)));
                    const postsQuery = query(collection(db, `artifacts/${appId}/public/data/posts`), orderBy("timestamp", "desc"));
                    onSnapshot(postsQuery, async (snapshot) => {
                        await displayPosts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                } catch (e) { noPostsMessage.textContent = "Could not get location. Please enable it to see nearby posts."; }
            });
            
            // Event Listeners
            window.addEventListener('hashchange', router);
            window.addEventListener('DOMContentLoaded', router);

            postComposerTextarea.addEventListener('input', () => composerPostBtn.classList.toggle('enabled', postComposerTextarea.value.trim().length > 0));
            composerPostBtn.addEventListener('click', () => { if (composerPostBtn.classList.contains('enabled')) handlePostSubmit(); });
            postsContainer.addEventListener('click', (e) => {
                const likeBtn = e.target.closest('.action-item.like');
                if (likeBtn) toggleLike(likeBtn.dataset.postId);
            });
            useAiPostBtn.addEventListener('click', () => {
                if (aiGeneratedContent.value.trim()) {
                    postComposerTextarea.value = aiGeneratedContent.value.trim();
                    postComposerTextarea.dispatchEvent(new Event('input'));
                    window.location.hash = '#home'; // Navigate home
                }
            });
        }
        
        initializeAppLogic();
    </script>
</body>
</html>