<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden; 
        }
        .main-wrapper {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px; 
            height: calc(100vh - 40px); 
            display: flex;
            flex-direction: column;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .app-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .app-modal-content {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .post-square {
            background-color: #e0e0e0; /* Grey color for squares */
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #d1d5db; /* Lighter border */
            min-height: 150px; /* Minimum height for squares */
            aspect-ratio: 1 / 1; /* Keep them square */
        }
        .post-square .text-content {
            flex-grow: 1;
            overflow: hidden;
            word-wrap: break-word;
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.4;
            display: -webkit-box;
            line-clamp: 4; /* Limit text to 4 lines when image is present */
            -webkit-box-orient: vertical;
        }
        .post-square .meta-info {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .post-square .link-preview-image {
            width: 100%;
            max-height: 80px; 
            object-fit: contain; /* Contain the image within the allocated space */
            border-radius: 4px;
            margin-bottom: 8px;
            background-color: #f3f4f6; /* Light background for image area */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Hide overflow from images */
        }
        .post-square .link-preview-image img {
            max-width: 100%;
            max-height: 100%;
            display: block; /* Remove extra space below image */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            display: none; /* Hidden by default */
            font-family: 'Inter', sans-serif;
            max-width: 90%;
        }
        .message-box button {
            background-color: #ee9e36;
            color: #ffffff;
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1rem;
        }
        .message-box button:hover {
            background-color: #9eb09f;
        }
        .message-box.show {
            display: block;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none; /* Hidden by default */
        }
        .loading-spinner.show {
            display: block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for post feed */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .sidebar-buttons {
            position: fixed;
            top: 20px; 
            left: 20px; 
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .sidebar-button {
            width: 60px; 
            height: 60px;
            border-radius: 12px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, background-color 0.3s ease;
            cursor: pointer;
            text-align: center;
            line-height: 1.2;
            padding: 5px;
            margin-top: 23px;
            margin-right: 2px;
            margin-left: 12px;
            font-weight: 500;
        }
        .sidebar-button:hover {
            transform: scale(1.05);
        }
        .sidebar-button#add-post-btn {
            background-color: #3b82f6; 
            font-size: 2rem; 
            padding: 0; 
        }
        .sidebar-button#ai-post-btn {
            background-color: #a855f7; /* Purple for AI post */
        }
        .sidebar-button#profiles-btn {
            background-color: #ef4444; /* Red for profiles */
        }
         .sidebar-button#enable-notifs-btn {
            background-color: #f59e0b; /* Orange for notifications */
        }
        .sidebar-button#google-auth-btn { /* Changed ID to reflect dual purpose */
            background-color: #fee9e9; /* White background for Google button */
            color: #333; 
            margin-top: 20px; 
            height: auto; 
            padding: 10px 5px;
            font-size: 0.85rem;
            line-height: 1.2;
            display: flex; /* Always display */
            flex-direction: column; /* Stack icon and text */
            align-items: center;
            justify-content: center;
            gap: 4px; /* Space between icon and text */
            border: 1px solid #ccc; /* Subtle border */
        }
     
        .summarize-btn {
            background-color: #22c55e; /* Green for summarize */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
            cursor: pointer;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .summarize-btn:hover {
            background-color: #8454cb;
        }
        .summary-modal-content {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .summary-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #374151;
            margin-bottom: 15px;
            text-align: left;
        }
        .profile-list-container {
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9fafb;
            margin-top: 15px;
        }
        .profile-item {
            padding: 8px 0;
            border-bottom: 1px dashed #d1d5db;
            font-size: 0.9rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-item:last-child {
            border-bottom: none;
        }
        .profile-icon {
            font-size: 1.2rem;
            color: #6b7280;
        }
        .profile-item img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .main-wrapper {
                padding: 16px;
                height: calc(100vh - 20px);
            }
            .app-modal-content {
                padding: 20px;
            }
            .post-square {
                padding: 12px;
                min-height: 120px;
            }
            .post-square .text-content {
                font-size: 0.85rem;
            }
            .post-square .meta-info {
                font-size: 0.65rem;
            }
            #posts-grid {
                grid-template-columns: 1fr;
            }
            .sidebar-buttons {
                top: 10px;
                left: 10px;
                flex-direction: row; /* Layout side-by-side on small screens */
                width: auto;
                gap: 5px;
            }
            .sidebar-button {
                width: 45px;
                height: 45px;
                font-size: 0.8rem;
            }
            .sidebar-button#add-post-btn {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center">
    <!-- Sidebar Buttons for New Post and AI Post -->
    <div class="sidebar-buttons">
        <button id="add-post-btn" class="sidebar-button">
            +
        </button>
        <button id="ai-post-btn" class="sidebar-button">
            AI Post
        </button>
        <button id="profiles-btn" class="sidebar-button">
            People 
            Nearby
        </button>
        <button id="enable-notifs-btn" class="sidebar-button">Enable Notifs</button>
        <button id="google-auth-btn" class="sidebar-button">
            <span id="google-auth-text">Sign in with Google</span>
        </button>
    </div>

    <div class="main-wrapper">
        
        <div id="post-modal" class="hidden app-modal">
            <div class="app-modal-content">
                <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Create Post</h2>
                <textarea id="post-content" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y" placeholder="What's on your mind?"></textarea>
                <input type="url" id="post-link" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 mt-3" placeholder="Optional: Add a link (e.g., https://example.com)">
                
                <button id="generate-hashtags-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md flex items-center justify-center gap-2">
                 Generate Hashtags
                    <div id="hashtag-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>

                <button id="post-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Post
                </button>
                <p id="location-status" class="text-sm text-gray-500 text-center mt-2">Getting location for post...</p>
                <div id="location-loading-spinner" class="loading-spinner mt-2"></div>
            </div>
        </div>

        <div id="ai-post-modal" class="hidden app-modal">
            <div class="app-modal-content">
                <button id="close-ai-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Generate Post with AI</h2>
                <textarea id="ai-prompt-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-200 resize-y" placeholder="Enter topic or prompt for AI (e.g., 'A beautiful sunset at the beach')"></textarea>
                
                <button id="generate-ai-post-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md flex items-center justify-center gap-2">
                    Generate Post
                    <div id="ai-post-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>

                <textarea id="ai-generated-content" rows="6" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 mt-4 focus:outline-none resize-y" placeholder="Generated content will appear here..."></textarea>
                
                <button id="use-ai-post-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Use This Post
                </button>
            </div>
        </div>
 
        <div id="summary-modal" class="hidden app-modal">
            <div class="summary-modal-content">
                <button id="close-summary-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Post Summary</h2>
                <div id="summary-content" class="summary-text text-gray-800"></div>
                <div id="summary-loading-spinner" class="loading-spinner mt-2"></div>
            </div>
        </div>

        <div id="profiles-modal" class="hidden app-modal">
            <div class="app-modal-content">
                <button id="close-profiles-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Other Profiles near you</h2>
                <div id="profiles-list" class="profile-list-container">
                    <p class="text-gray-500 text-center">Loading...</p>
                </div>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
            <div id="posts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
            </div>
            <p id="no-posts-message" class="text-gray-500 text-center mt-8 text-lg">No posts found nearby. Be the first to post!</p>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 pt-4 border-t border-gray-200 text-sm text-gray-600 gap-2 sm:gap-0">
            <p id="location-display" class="font-semibold text-gray-700">Current Location: <span id="current-location-value">Loading...</span></p>
            <p id="user-id-display-footer" class="font-semibold text-gray-700">User ID: <span id="user-id-value">Loading...</span></p>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="message-box">
        <p id="messageBoxContent"></p>
        <button onclick="document.getElementById('messageBox').classList.remove('show');">OK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAE37qdlDBYSUhumSO6jTA985V81DN9iA8",
                authDomain: "lowk-be8e0.firebaseapp.com",
                projectId: "lowk-be8e0",
                storageBucket: "lowk-be8e0.firebasestorage.app",
                messagingSenderId: "244867743683",
                appId: "1:244867743683:web:1b11ac7b94462ef5314776"
            };
 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config === 'undefined') {
            console.warn(`Local run detected. Using provided firebaseConfig. Ensure 'Anonymous' auth and 'Google' auth are enabled in Firebase and Firestore rules allow read/write for 'artifacts/${appId}/public/data/posts' AND 'artifacts/${appId}/public/data/users'.`);
        }

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserDisplayName = "Guest";
        let currentUserPhotoURL = ""; 
        let userLocation = null;
        const addPostBtn = document.getElementById('add-post-btn');
        const aiPostBtn = document.getElementById('ai-post-btn');
        const profilesBtn = document.getElementById('profiles-btn');
        const googleAuthBtn = document.getElementById('google-auth-btn');                             
        const googleAuthText = document.getElementById('google-auth-text');         
        const postModal = document.getElementById('post-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const postContentInput = document.getElementById('post-content');
        const postLinkInput = document.getElementById('post-link');
        const postButton = document.getElementById('post-button');
        
        const aiPostModal = document.getElementById('ai-post-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const generateAiPostBtn = document.getElementById('generate-ai-post-btn');
        const aiGeneratedContent = document.getElementById('ai-generated-content');
        const useAiPostBtn = document.getElementById('use-ai-post-btn');
        const aiPostLoadingSpinner = document.getElementById('ai-post-loading-spinner');

        const summaryModal = document.getElementById('summary-modal');
        const closeSummaryModalBtn = document.getElementById('close-summary-modal-btn');
        const summaryContent = document.getElementById('summary-content');
        const summaryLoadingSpinner = document.getElementById('summary-loading-spinner');

        const profilesModal = document.getElementById('profiles-modal');
        const closeProfilesModalBtn = document.getElementById('close-profiles-modal-btn');
        const profilesList = document.getElementById('profiles-list');
        
        const enableNotifsBtn = document.getElementById('enable-notifs-btn');

        const postsGrid = document.getElementById('posts-grid');
        const noPostsMessage = document.getElementById('no-posts-message');
        const userIdValueDisplay = document.getElementById('user-id-value');
        const currentLocationValueDisplay = document.getElementById('current-location-value');
        const locationStatus = document.getElementById('location-status');
        const locationLoadingSpinner = document.getElementById('location-loading-spinner');
        const messageBox = document.getElementById('messageBox');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const generateHashtagsBtn = document.getElementById('generate-hashtags-btn');
        const hashtagLoadingSpinner = document.getElementById('hashtag-loading-spinner');

        
        const userProfilesCache = {};

        // --- PUSH NOTIFICATION SETUP ---

        // IMPORTANT: Replace with your own VAPID public key.
        // You can generate a new key pair by running `npx web-push generate-vapid-keys` in your terminal.
        const VAPID_PUBLIC_KEY = ' BJZ63z2FfyPJsV9OpL1ptKpRggpgebhutvSwf_764SwYbCr9P69UV0sveQSVIZGkLA0Sb9vnhYr5AdeejkZQCf4 ';

        // --- PUSH NOTIFICATION ARCHITECTURE NOTE  ---
        // A true push notification system (sending notifications to users even when they're not on the site)
        // requires a server-side component, like a Firebase Cloud Function. The flow would be:
        // 1. Client (this app): Asks for permission, gets a unique push subscription token from the browser.
        // 2. Client (this app): Sends this token to your server and stores it, associated with the user ID. (This part is implemented below, storing it in Firestore).
        // 3. Backend (e.g., a Firebase Cloud Function): When a new post is created, this function would find nearby users, look up their tokens, and send a push message.
        //
        // Since this is a single client-side file, we SIMULATE this. The app listens for new posts in real-time
        // and triggers a LOCAL notification on your own device if a new post appears nearby. The code is structured
        // to be easily adapted to a real backend later.
        // -------------------------------------------

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.warn("Service Workers not supported by this browser.");
                return;
            }

            // In-line service worker code
            const swCode = `
                self.addEventListener('notificationclick', event => {
                    event.notification.close();
                    console.log('Notification clicked. URL to open:', event.notification.data.url);
                    event.waitUntil(
                        clients.openWindow(event.notification.data.url)
                    );
                });
            `;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);

            try {
                const registration = await navigator.serviceWorker.register(swUrl);
                console.log('Service Worker registered successfully:', registration);
            } catch (error) {
                console.error('Service Worker registration failed:', error);
                showMessageBox("Could not set up notification service.");
            }
        }

        async function subscribeUserToPush() {
            if (VAPID_PUBLIC_KEY === 'YOUR_VAPID_PUBLIC_KEY_HERE') {
                console.error("VAPID_PUBLIC_KEY is not set. Cannot subscribe for push notifications.");
                showMessageBox("Notification setup is incomplete on this site. (VAPID key missing)");
                return;
            }

            try {
                const registration = await navigator.serviceWorker.ready;
                const existingSubscription = await registration.pushManager.getSubscription();
                if (existingSubscription) {
                    console.log('User is already subscribed.');
                    showMessageBox('You are already subscribed to notifications.');
                    return;
                }

                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                console.log('User subscribed successfully.');
                await saveSubscription(subscription);

            } catch (error) {
                console.error('Failed to subscribe user:', error);
                showMessageBox(`Failed to enable notifications: ${error.message}`);
            }
        }
        
        async function saveSubscription(subscription) {
            if (!currentUserId || !db) {
                showMessageBox("You must be signed in to enable notifications.");
                return;
            };
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUserId);
            try {
                // Convert subscription to a plain object for Firestore
                const subscriptionObject = JSON.parse(JSON.stringify(subscription));
                await setDoc(userDocRef, { pushSubscription: subscriptionObject }, { merge: true });
                console.log("Push subscription saved for user:", currentUserId);
                showMessageBox("Push notifications enabled! You'll be notified of new posts nearby.");
            } catch (error) {
                console.error("Failed to save push subscription:", error);
                showMessageBox("Could not save your notification settings.");
            }
        }

        enableNotifsBtn.addEventListener('click', async () => {
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                showMessageBox("Push notifications are not supported by your browser.");
                return;
            }

            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                console.log('Notification permission granted.');
                await subscribeUserToPush();
            } else {
                showMessageBox("Notification permission was denied. You can change this in your browser settings.");
            }
        });


        // --- END PUSH NOTIFICATION SETUP ---

        
        function showMessageBox(message) {
            messageBoxContent.textContent = message;
            messageBox.classList.add('show');
        }

        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // cool cow-culator
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
 
            const distance = R * c; // in meters
            return distance;
        }

        function getDomainFromUrl(url) {
            try {
                const hostname = new URL(url).hostname;
                return hostname.startsWith('www.') ? hostname.substring(4) : hostname;
            } catch (e) {
                console.error("Invalid URL for domain extraction:", url, e);
                return null;
            }
        }

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                locationLoadingSpinner.classList.add('show');
                locationStatus.textContent = 'Getting your location...';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };
                            locationLoadingSpinner.classList.remove('show');
                            currentLocationValueDisplay.textContent = `${userLocation.latitude.toFixed(4)}, ${userLocation.longitude.toFixed(4)}`;
                            locationStatus.textContent = `Location acquired.`;
                            console.log("Geolocation: User location obtained:", userLocation);
                            resolve(userLocation);
                        },
                        (error) => {
                            locationLoadingSpinner.classList.remove('show');
                            let errorMessage = 'Unable to retrieve your location.';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "Location access denied. Please allow location access in your browser settings.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Location information is unavailable. Try again later.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "Request to get user location timed out. Check your network or GPS.";
                                    break;
                                default:
                                    errorMessage = `An unknown error occurred: ${error.message}`;
                                    break;
                            }
                            currentLocationValueDisplay.textContent = "Error getting location";
                            locationStatus.textContent = errorMessage;
                            console.error("Geolocation Error:", error);
                            showMessageBox(errorMessage);
                            reject(new Error(errorMessage));
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    const errorMessage = "Geolocation is not supported by your browser.";
                    locationLoadingSpinner.classList.remove('show');
                    currentLocationValueDisplay.textContent = "Not supported";
                    locationStatus.textContent = errorMessage;
                    showMessageBox(errorMessage);
                    console.error("Geolocation Error: Browser does not support Geolocation.");
                    reject(new Error(errorMessage));
                }
            });
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    await signOut(auth);
                    console.log("Signed out anonymous user before Google sign-in.");
                }

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Google Sign-in successful:", user);

                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                await setDoc(userDocRef, {
                    uid: user.uid,
                    displayName: user.displayName || 'Unnamed User',
                    photoURL: user.photoURL || '',
                    email: user.email || '',
                    lastSignInTime: Date.now()
                }, { merge: true });
                showMessageBox(`Welcome, ${user.displayName || 'User'}!`);

            } catch (error) {
                console.error("Google Sign-in Error:", error.code, error.message, error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessageBox("Google Sign-in was cancelled.");
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showMessageBox("Another sign-in request is already in progress.");
                } else {
                    showMessageBox(`Google Sign-in failed: ${error.message}. Please try again.`);
                }
                if (!auth.currentUser) { 
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously as fallback after Google sign-in attempt.");
                }
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log("User signed out.");
                showMessageBox("You have been signed out.");
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageBox(`Failed to sign out: ${error.message}`);
            }
        }

        function updateGoogleAuthButton(user) {
            if (user && !user.isAnonymous) {
                googleAuthText.textContent = 'Sign Out';
                googleAuthBtn.onclick = handleSignOut;
                googleAuthBtn.classList.remove('bg-white', 'text-gray-800', 'border-gray-300'); // Remove Google Sign-in specific styling
                googleAuthBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white', 'font-semibold'); // Add generic sign out styling
            } else {
                googleAuthText.textContent = 'Sign in with Google';
                googleAuthBtn.onclick = handleGoogleSignIn;
                googleAuthBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white', 'font-semibold'); // Remove generic sign out styling
                googleAuthBtn.classList.add('bg-white', 'text-gray-800', 'border-gray-300'); // Restore Google Sign-in specific styling
            }
        }


        // Fetch user profile from Firestore or cache
        async function getUserProfile(userId) {
            if (userProfilesCache[userId]) {
                return userProfilesCache[userId];
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    userProfilesCache[userId] = userDocSnap.data();
                    return userProfilesCache[userId];
                } else {
                    console.warn(`User profile not found for ID: ${userId}.`);
                    return { uid: userId, displayName: "Unknown User", photoURL: "" };
                }
            } catch (error) {
                console.error(`Error fetching user profile for ID ${userId}:`, error);
                return { uid: userId, displayName: "Error User", photoURL: "" };
            }
        }


        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await registerServiceWorker(); // Register the service worker on startup

                console.log("Firebase app initialized successfully.");

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token (Canvas environment).");
                    } catch (tokenError) {
                        console.warn("Custom token sign-in failed, letting onAuthStateChanged handle it.", tokenError);
                    }
                } else {
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (local/initial, no existing user).");
                    }
                }


                onAuthStateChanged(auth, async (user) => {
                    updateGoogleAuthButton(user); 

                    if (user) {
                        currentUserId = user.uid;
                        const profile = await getUserProfile(user.uid);
                        currentUserDisplayName = profile.displayName || user.displayName || (user.isAnonymous ? 'Guest' : 'User');
                        currentUserPhotoURL = profile.photoURL || user.photoURL || '';

                        userIdValueDisplay.textContent = currentUserDisplayName; 
                        console.log("Firebase user signed in:", currentUserId, "Name:", currentUserDisplayName);
                        getUserLocation().then(() => {
                            setupPostListener();
                        }).catch(err => console.error("Error getting location after auth:", err));

                    } else {
                        currentUserId = null;
                        currentUserDisplayName = "Guest";
                        currentUserPhotoURL = "";
                        userIdValueDisplay.textContent = 'Not signed in';
                        console.log("No user signed in.");
                        showMessageBox("Please sign in to post and see personalized content.");
                    }
                });

            } catch (error) {
                console.error("Critical Error during Firebase initialization or sign-in:", error.code, error.message, error);
                showMessageBox(`Failed to initialize the app: ${error.message}. Please check console for details.`);
            }
        }

        async function showLocalNotification(post) {
            if (Notification.permission !== 'granted' || !('serviceWorker' in navigator)) {
                return; // Don't show if permission not granted or SW not supported
            }

            try {
                const authorProfile = await getUserProfile(post.userId);
                const title = `New post from ${authorProfile.displayName || 'a user'}!`;
                const body = post.text.length > 100 ? post.text.substring(0, 97) + '...' : post.text;
                const icon = authorProfile.photoURL || 'https://placehold.co/192x192/cccccc/333333?text=🔔'; // Use profile pic as icon
                const url = window.location.href; // URL to open on click

                const registration = await navigator.serviceWorker.ready;
                registration.showNotification(title, {
                    body: body,
                    icon: icon,
                    badge: icon,
                    data: { url: url } // Pass URL to the click handler in the service worker
                });
                console.log("Local notification shown for post:", post.id);
            } catch (error) {
                console.error("Error showing local notification:", error);
            }
        }

        function displayPosts(postsData) {
            postsGrid.innerHTML = ''; // Clear existing posts
            let foundNearby = false;

            if (!userLocation) {
                noPostsMessage.textContent = "Your location is required to filter local posts. Please enable location services in your browser.";
                noPostsMessage.style.display = 'block';
                return;
            }
            
            if (postsData.length === 0) {
                 noPostsMessage.textContent = "No posts found. Be the first to post!";
                 noPostsMessage.style.display = 'block';
                 return;
            }

            (async () => {
                for (const post of postsData) { 
                    if (post.location && post.location.latitude && post.location.longitude) {
                        const distance = calculateDistance(
                            userLocation.latitude, userLocation.longitude,
                            post.location.latitude, post.location.longitude
                        );
                        
                        if (distance <= 500) { // Within 500 meters
                            foundNearby = true;
                            const postSquare = document.createElement('div');
                            postSquare.className = 'post-square';

                            const timestamp = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'N/A';
                            const distanceDisplay = distance < 1 ? '<1m' : `${distance.toFixed(0)}m`;

                            let linkPreviewHtml = '';
                            if (post.linkUrl) {
                                const domain = getDomainFromUrl(post.linkUrl);
                                const faviconUrl = domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=64` : '';
                                linkPreviewHtml = `
                                    <div class="link-preview-image">
                                        <a href="${post.linkUrl}" target="_blank" rel="noopener noreferrer">
                                            <img src="${faviconUrl}" onerror="this.onerror=null;this.src='https://placehold.co/64x64/dddddd/aaaaaa?text=Link';" alt="Link preview">
                                        </a>
                                    </div>
                                `;
                            }
                            
                            const authorProfile = await getUserProfile(post.userId);
                            const authorName = authorProfile.displayName || post.userId.substring(0, 5) + '...';
                            const authorPhoto = authorProfile.photoURL || 'https://placehold.co/32x32/cccccc/333333?text=👤';

                            const summarizeButton = `<button class="summarize-btn" data-post-text="${encodeURIComponent(post.text)}">✨ Summarize</button>`;

                            postSquare.innerHTML = `
                                ${linkPreviewHtml}
                                <div class="text-content">${post.text}</div>
                                <div class="meta-info">
                                    <span class="flex items-center gap-1">
                                        <img src="${authorPhoto}" class="w-4 h-4 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=👤';" alt="Profile Picture">
                                        By: <span class="font-medium">${authorName}</span>
                                    </span>
                                    <span>${timestamp}</span>
                                    <span>${distanceDisplay} away</span>
                                    ${summarizeButton}
                                </div>
                            `;
                            postsGrid.appendChild(postSquare);
                        }
                    }
                }

                if (!foundNearby && postsData.length > 0) {
                    noPostsMessage.textContent = "No posts found within 500 meters of your current location.";
                    noPostsMessage.style.display = 'block';
                } else if (foundNearby) {
                    noPostsMessage.style.display = 'none';
                }

                document.querySelectorAll('.summarize-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const postText = decodeURIComponent(event.target.dataset.postText);
                        showSummaryModal(postText);
                    });
                });
            })();
        }

        function setupPostListener() {
            if (!db) {
                console.error("Firestore not initialized, cannot set up listener.");
                return;
            }

            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
            console.log(`Setting up Firestore listener for path: artifacts/${appId}/public/data/posts`);

            onSnapshot(query(postsCollectionRef), (snapshot) => {
                const allPosts = [];
                snapshot.forEach(doc => allPosts.push({ id: doc.id, ...doc.data() }));

                // Process changes for notifications
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const newPost = { id: change.doc.id, ...change.doc.data() };
                        // Trigger notification only for new posts from other users that are nearby
                        if (newPost.userId !== currentUserId && userLocation && newPost.location) {
                            const distance = calculateDistance(userLocation.latitude, userLocation.longitude, newPost.location.latitude, newPost.location.longitude);
                            if (distance <= 500) {
                                console.log("New nearby post detected, triggering local notification.");
                                await showLocalNotification(newPost);
                            }
                        }
                    }
                });

                // Sort and display all posts
                allPosts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                displayPosts(allPosts);

            }, (error) => {
                console.error("Error fetching posts:", error);
                showMessageBox(`Failed to load posts: ${error.message}.`);
            });
        }

        async function generateHashtags() {
            const postContent = postContentInput.value.trim();
            if (!postContent) { showMessageBox("Please write some content first."); return; }

            hashtagLoadingSpinner.classList.add('show');
            generateHashtagsBtn.disabled = true;

            try {
                const prompt = `Generate 3-5 relevant and popular hashtags for the following post. Provide only the hashtags, separated by spaces. Post: '${postContent}'`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyC0iXmXyUU_rMXFLCF8T63_mUDIgzCl8Io"; // API KEY REMOVED
                if (!apiKey) throw new Error("API key is not configured.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                const hashtags = result.candidates[0].content.parts[0].text.trim();
                postContentInput.value += "\n\n" + hashtags;
            } catch (error) {
                console.error("Error generating hashtags:", error);
                showMessageBox(`Failed to generate hashtags: ${error.message}.`);
            } finally {
                hashtagLoadingSpinner.classList.remove('show');
                generateHashtagsBtn.disabled = false;
            }
        }

        async function generateAIPost() {
            const aiPrompt = aiPromptInput.value.trim();
            if (!aiPrompt) { showMessageBox("Please enter a topic for the AI."); return; }
            aiPostLoadingSpinner.classList.add('show');
            generateAiPostBtn.disabled = true;

            try {
                const prompt = `Write a short, engaging social media post (50-100 words) about: '${aiPrompt}'. Do not include hashtags.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyC0iXmXyUU_rMXFLCF8T63_mUDIgzCl8Io"; // API KEY REMOVED
                if (!apiKey) throw new Error("API key is not configured.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                aiGeneratedContent.value = result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("Error generating AI post:", error);
                showMessageBox(`Failed to generate post: ${error.message}.`);
            } finally {
                aiPostLoadingSpinner.classList.remove('show');
                generateAiPostBtn.disabled = false;
            }
        }

        async function generatePostSummary(postText) {
            summaryModal.classList.remove('hidden');
            summaryContent.textContent = 'Generating summary...';
            summaryLoadingSpinner.classList.add('show');

            try {
                const prompt = `Summarize the following post in 1-2 concise sentences: '${postText}'`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyC0iXmXyUU_rMXFLCF8T63_mUDIgzCl8Io"; // API KEY REMOVED
                if (!apiKey) throw new Error("API key is not configured.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                summaryContent.textContent = result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                summaryContent.textContent = `Failed to generate summary: ${error.message}.`;
                console.error("Error generating summary:", error);
            } finally {
                summaryLoadingSpinner.classList.remove('show');
            }
        }

        function showSummaryModal(postText) { generatePostSummary(postText); }

        async function fetchAndDisplayUserProfiles() {
            profilesList.innerHTML = '<p class="text-gray-500 text-center">Loading...</p>';
            try {
                if (!db) throw new Error("Database not ready.");
                const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
                const querySnapshot = await getDocs(query(usersCollectionRef));
                profilesList.innerHTML = '';
                if (querySnapshot.empty) {
                    profilesList.innerHTML = '<p class="text-center">No user profiles yet.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.isAnonymous) return; // Don't show anonymous users
                        const profileItem = document.createElement('div');
                        profileItem.className = 'profile-item';
                        profileItem.innerHTML = `
                            <img src="${userData.photoURL || 'https://placehold.co/32x32/cccccc/333333?text=👤'}" class="w-8 h-8 rounded-full object-cover" alt="PFP">
                            <span class="font-medium">${userData.displayName || 'User'}</span>
                        `;
                        profilesList.appendChild(profileItem);
                        userProfilesCache[userData.uid] = userData;
                    });
                }
            } catch (error) {
                console.error("Error fetching user profiles:", error);
                profilesList.innerHTML = `<p class="text-red-500 text-center">Failed to load profiles: ${error.message}.</p>`;
            }
        }

        postButton.addEventListener('click', async () => {
            const postContent = postContentInput.value.trim();
            const postLink = postLinkInput.value.trim();

            if (!postContent && !postLink) { showMessageBox("Post content or a link must be provided."); return; }
            if (!currentUserId) { showMessageBox("You must be signed in to post."); return; }
            if (!userLocation) {
                showMessageBox("Location not found. Please wait or enable location services.");
                await getUserLocation();
                if (!userLocation) { showMessageBox("Could not get location. Post cancelled."); return; }
            }

            try {
                const postData = { userId: currentUserId, text: postContent, timestamp: Date.now(), location: userLocation };
                if (postLink) postData.linkUrl = postLink;
                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), postData);
                postContentInput.value = '';
                postLinkInput.value = '';
                postModal.classList.add('hidden');
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox(`Failed to add post: ${error.message}.`);
            }
        });

        addPostBtn.addEventListener('click', () => {
            postModal.classList.remove('hidden');
            locationStatus.textContent = 'Getting location...';
            locationLoadingSpinner.classList.add('show');
            getUserLocation();
        });
        closeModalBtn.addEventListener('click', () => postModal.classList.add('hidden'));
        generateHashtagsBtn.addEventListener('click', generateHashtags);
        aiPostBtn.addEventListener('click', () => aiPostModal.classList.remove('hidden'));
        closeAiModalBtn.addEventListener('click', () => aiPostModal.classList.add('hidden'));
        generateAiPostBtn.addEventListener('click', generateAIPost);
        useAiPostBtn.addEventListener('click', () => {
            if (aiGeneratedContent.value.trim()) {
                postContentInput.value = aiGeneratedContent.value.trim();
                aiPostModal.classList.add('hidden');
                postModal.classList.remove('hidden');
                postLinkInput.value = '';
            } else { showMessageBox("No AI post generated to use."); }
        });
        closeSummaryModalBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        profilesBtn.addEventListener('click', () => {
            profilesModal.classList.remove('hidden');
            fetchAndDisplayUserProfiles();
        });
        closeProfilesModalBtn.addEventListener('click', () => profilesModal.classList.add('hidden'));
        
        initializeFirebase();
    </script>
</body>
</html>