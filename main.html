<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Social Feed</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center; /* Center vertically in case content is short */
            min-height: 100vh;
            padding: 20px;
            overflow: hidden; /* Prevent body scroll, let inner content scroll */
        }
        .main-wrapper {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px; /* Increased max-width for wider grid */
            height: calc(100vh - 40px); /* Fill screen height minus padding */
            display: flex;
            flex-direction: column;
            padding: 24px;
            position: relative;
            overflow: hidden; /* For inner scrollable content */
        }
        /* Common modal styling */
        .app-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .app-modal-content {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .post-square {
            background-color: #e0e0e0; /* Grey color for squares */
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #d1d5db; /* Lighter border */
            min-height: 150px; /* Minimum height for squares */
            aspect-ratio: 1 / 1; /* Keep them square */
        }
        .post-square .text-content {
            flex-grow: 1;
            overflow: hidden;
            word-wrap: break-word;
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Limit text to 4 lines when image is present */
            -webkit-box-orient: vertical;
        }
        .post-square .meta-info {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .post-square .link-preview-image {
            width: 100%;
            max-height: 80px; /* Fixed height for image preview */
            object-fit: contain; /* Contain the image within the allocated space */
            border-radius: 4px;
            margin-bottom: 8px;
            background-color: #f3f4f6; /* Light background for image area */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Hide overflow from images */
        }
        .post-square .link-preview-image img {
            max-width: 100%;
            max-height: 100%;
            display: block; /* Remove extra space below image */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            display: none; /* Hidden by default */
            font-family: 'Inter', sans-serif;
            max-width: 90%;
        }
        .message-box button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1rem;
        }
        .message-box button:hover {
            background-color: #45a049;
        }
        .message-box.show {
            display: block;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none; /* Hidden by default */
        }
        .loading-spinner.show {
            display: block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for post feed */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Sidebar buttons for New Post and AI Post */
        .sidebar-buttons {
            position: fixed;
            top: 20px; /* Adjust as needed */
            left: 20px; /* Adjust as needed */
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between buttons */
        }
        .sidebar-button {
            width: 60px; /* Slightly wider for text */
            height: 60px;
            border-radius: 12px; /* Square with rounded corners */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, background-color 0.3s ease;
            cursor: pointer;
            text-align: center;
            line-height: 1.2;
            padding: 5px;
            font-weight: 500;
        }
        .sidebar-button:hover {
            transform: scale(1.05);
        }
        .sidebar-button#add-post-btn {
            background-color: #3b82f6; /* Blue for new post */
            font-size: 2rem; /* Larger plus sign */
            padding: 0; /* Reset padding for plus */
        }
        .sidebar-button#ai-post-btn {
            background-color: #a855f7; /* Purple for AI post */
        }
        .sidebar-button#profiles-btn {
            background-color: #ef4444; /* Red for profiles */
        }
        .sidebar-button#google-sign-in-btn {
            background-color: #db4437; /* Google red */
            margin-top: 20px; /* Space from other buttons */
            height: auto; /* Allow button to resize to content */
            padding: 10px 5px;
            font-size: 0.85rem;
            line-height: 1.2;
        }
        .summarize-btn {
            background-color: #22c55e; /* Green for summarize */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
            cursor: pointer;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .summarize-btn:hover {
            background-color: #16a34a;
        }
        .summary-modal-content {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .summary-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #374151;
            margin-bottom: 15px;
            text-align: left;
        }
        .profile-list-container {
            max-height: 400px; /* Limit height for scrollability */
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9fafb;
            margin-top: 15px;
        }
        .profile-item {
            padding: 8px 0;
            border-bottom: 1px dashed #d1d5db;
            font-size: 0.9rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-item:last-child {
            border-bottom: none;
        }
        .profile-icon {
            font-size: 1.2rem;
            color: #6b7280;
        }
        .profile-item img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .main-wrapper {
                padding: 16px;
                height: calc(100vh - 20px);
            }
            .app-modal-content {
                padding: 20px;
            }
            .post-square {
                padding: 12px;
                min-height: 120px;
            }
            .post-square .text-content {
                font-size: 0.85rem;
            }
            .post-square .meta-info {
                font-size: 0.65rem;
            }
            #posts-grid {
                grid-template-columns: 1fr;
            }
            .sidebar-buttons {
                top: 10px;
                left: 10px;
                flex-direction: row; /* Layout side-by-side on small screens */
                width: auto;
                gap: 5px;
            }
            .sidebar-button {
                width: 45px;
                height: 45px;
                font-size: 0.8rem;
            }
            .sidebar-button#add-post-btn {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center">
    <!-- Sidebar Buttons for New Post and AI Post -->
    <div class="sidebar-buttons">
        <button id="add-post-btn" class="sidebar-button">
            +
        </button>
        <button id="ai-post-btn" class="sidebar-button">
            AI Post
        </button>
        <button id="profiles-btn" class="sidebar-button">
            Profiles
        </button>
        <!-- New Google Sign-in Button -->
        <button id="google-sign-in-btn" class="sidebar-button">
            Sign in with Google
        </button>
    </div>

    <div class="main-wrapper">
        <!-- Post Input Modal -->
        <div id="post-modal" class="hidden app-modal">
            <div class="app-modal-content">
                <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Create Post</h2>
                <textarea id="post-content" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y" placeholder="What's on your mind?"></textarea>
                <input type="url" id="post-link" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 mt-3" placeholder="Optional: Add a link (e.g., https://example.com)">
                
                <button id="generate-hashtags-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md flex items-center justify-center gap-2">
                    <span class="text-xl">âœ¨</span> Generate Hashtags
                    <div id="hashtag-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>

                <button id="post-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Post
                </button>
                <p id="location-status" class="text-sm text-gray-500 text-center mt-2">Getting location for post...</p>
                <div id="location-loading-spinner" class="loading-spinner mt-2"></div>
            </div>
        </div>

        <!-- AI Post Generation Modal -->
        <div id="ai-post-modal" class="hidden app-modal">
            <div class="app-modal-content">
                <button id="close-ai-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Generate Post with AI</h2>
                <textarea id="ai-prompt-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-200 resize-y" placeholder="Enter topic or prompt for AI (e.g., 'A beautiful sunset at the beach')"></textarea>
                
                <button id="generate-ai-post-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md flex items-center justify-center gap-2">
                    Generate Post
                    <div id="ai-post-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>

                <textarea id="ai-generated-content" rows="6" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 mt-4 focus:outline-none resize-y" placeholder="Generated content will appear here..."></textarea>
                
                <button id="use-ai-post-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Use This Post
                </button>
            </div>
        </div>

        <!-- Post Summary Modal -->
        <div id="summary-modal" class="hidden app-modal">
            <div class="summary-modal-content">
                <button id="close-summary-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Post Summary âœ¨</h2>
                <div id="summary-content" class="summary-text text-gray-800"></div>
                <div id="summary-loading-spinner" class="loading-spinner mt-2"></div>
            </div>
        </div>

        <!-- User Profiles Modal -->
        <div id="profiles-modal" class="hidden app-modal">
            <div class="app-modal-content">
                <button id="close-profiles-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Other User Profiles</h2>
                <div id="profiles-list" class="profile-list-container">
                    <!-- User profiles will be loaded here -->
                    <p class="text-gray-500 text-center">Loading user profiles...</p>
                </div>
            </div>
        </div>

        <!-- Main Content Area for Posts Grid -->
        <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
            <div id="posts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                <!-- Posts will be dynamically loaded here into squares -->
            </div>
            <p id="no-posts-message" class="text-gray-500 text-center mt-8 text-lg">No posts found nearby. Be the first to post!</p>
        </div>

        <!-- Footer for location and user ID -->
        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 pt-4 border-t border-gray-200 text-sm text-gray-600 gap-2 sm:gap-0">
            <p id="location-display" class="font-semibold text-gray-700">Current Location: <span id="current-location-value">Loading...</span></p>
            <p id="user-id-display-footer" class="font-semibold text-gray-700">User ID: <span id="user-id-value">Loading...</span></p>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="message-box">
        <p id="messageBoxContent"></p>
        <button onclick="document.getElementById('messageBox').classList.remove('show');">OK</button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the environment or replaced locally)
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                  apiKey: "AIzaSyAE37qdlDBYSUhumSO6jTA985V81DN9iA8",
  authDomain: "lowk-be8e0.firebaseapp.com",
  projectId: "lowk-be8e0",
  storageBucket: "lowk-be8e0.firebasestorage.app",
  messagingSenderId: "244867743683",
  appId: "1:244867743683:web:1b11ac7b94462ef5314776",
  measurementId: "G-LHZ53VWW03"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config === 'undefined') {
            console.warn(`Local run detected. Using provided firebaseConfig. Ensure 'Anonymous' auth and 'Google' auth are enabled in Firebase and Firestore rules allow read/write for 'artifacts/${appId}/public/data/posts' AND 'artifacts/${appId}/public/data/users'.`);
        }

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserDisplayName = "Guest"; // Store display name
        let currentUserPhotoURL = ""; // Store profile photo URL
        let userLocation = null;

        // Elements
        const addPostBtn = document.getElementById('add-post-btn');
        const aiPostBtn = document.getElementById('ai-post-btn');
        const profilesBtn = document.getElementById('profiles-btn');
        const googleSignInBtn = document.getElementById('google-sign-in-btn'); // New Google Sign-in button
        
        const postModal = document.getElementById('post-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const postContentInput = document.getElementById('post-content');
        const postLinkInput = document.getElementById('post-link');
        const postButton = document.getElementById('post-button');
        
        const aiPostModal = document.getElementById('ai-post-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const generateAiPostBtn = document.getElementById('generate-ai-post-btn');
        const aiGeneratedContent = document.getElementById('ai-generated-content');
        const useAiPostBtn = document.getElementById('use-ai-post-btn');
        const aiPostLoadingSpinner = document.getElementById('ai-post-loading-spinner');

        const summaryModal = document.getElementById('summary-modal');
        const closeSummaryModalBtn = document.getElementById('close-summary-modal-btn');
        const summaryContent = document.getElementById('summary-content');
        const summaryLoadingSpinner = document.getElementById('summary-loading-spinner');

        const profilesModal = document.getElementById('profiles-modal');
        const closeProfilesModalBtn = document.getElementById('close-profiles-modal-btn');
        const profilesList = document.getElementById('profiles-list');


        const postsGrid = document.getElementById('posts-grid');
        const noPostsMessage = document.getElementById('no-posts-message');
        const userIdValueDisplay = document.getElementById('user-id-value');
        const currentLocationValueDisplay = document.getElementById('current-location-value');
        const locationStatus = document.getElementById('location-status');
        const locationLoadingSpinner = document.getElementById('location-loading-spinner');
        const messageBox = document.getElementById('messageBox');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const generateHashtagsBtn = document.getElementById('generate-hashtags-btn');
        const hashtagLoadingSpinner = document.getElementById('hashtag-loading-spinner');

        // Cache for user profiles to avoid repeated Firestore reads
        const userProfilesCache = {};

        // Function to show a custom message box
        function showMessageBox(message) {
            messageBoxContent.textContent = message;
            messageBox.classList.add('show');
        }

        // Haversine formula to calculate distance between two lat/lon points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in metres
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // in metres
            return distance;
        }

        // Helper to extract domain from a URL for favicon
        function getDomainFromUrl(url) {
            try {
                const hostname = new URL(url).hostname;
                return hostname.startsWith('www.') ? hostname.substring(4) : hostname;
            } catch (e) {
                console.error("Invalid URL for domain extraction:", url, e);
                return null;
            }
        }

        // Get user's current location using Geolocation API
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                locationLoadingSpinner.classList.add('show');
                locationStatus.textContent = 'Getting your location...';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };
                            locationLoadingSpinner.classList.remove('show');
                            currentLocationValueDisplay.textContent = `${userLocation.latitude.toFixed(4)}, ${userLocation.longitude.toFixed(4)}`;
                            locationStatus.textContent = `Location acquired.`;
                            console.log("Geolocation: User location obtained:", userLocation);
                            resolve(userLocation);
                        },
                        (error) => {
                            locationLoadingSpinner.classList.remove('show');
                            let errorMessage = 'Unable to retrieve your location.';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "Location access denied. Please allow location access in your browser settings.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Location information is unavailable. Try again later.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "Request to get user location timed out. Check your network or GPS.";
                                    break;
                                default:
                                    errorMessage = `An unknown error occurred: ${error.message}`;
                                    break;
                            }
                            currentLocationValueDisplay.textContent = "Error getting location";
                            locationStatus.textContent = errorMessage;
                            console.error("Geolocation Error:", error);
                            showMessageBox(errorMessage);
                            reject(new Error(errorMessage));
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    const errorMessage = "Geolocation is not supported by your browser.";
                    locationLoadingSpinner.classList.remove('show');
                    currentLocationValueDisplay.textContent = "Not supported";
                    locationStatus.textContent = errorMessage;
                    showMessageBox(errorMessage);
                    console.error("Geolocation Error: Browser does not support Geolocation.");
                    reject(new Error(errorMessage));
                }
            });
        }

        // Function to handle Google Sign-in
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                // Sign out any anonymous user first to prevent conflicts
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    await signOut(auth);
                    console.log("Signed out anonymous user before Google sign-in.");
                }

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Google Sign-in successful:", user);

                // Save or update user profile in Firestore
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                await setDoc(userDocRef, {
                    uid: user.uid,
                    displayName: user.displayName || 'Unnamed User',
                    photoURL: user.photoURL || '',
                    email: user.email || '',
                    lastSignInTime: Date.now()
                }, { merge: true }); // Use merge to update existing fields without overwriting others
                showMessageBox(`Welcome, ${user.displayName || 'User'}!`);

            } catch (error) {
                console.error("Google Sign-in Error:", error.code, error.message, error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessageBox("Google Sign-in was cancelled.");
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showMessageBox("Another sign-in request is already in progress.");
                } else {
                    showMessageBox(`Google Sign-in failed: ${error.message}. Please try again.`);
                }
                // Fallback to anonymous sign-in if Google sign-in fails
                await signInAnonymously(auth);
            }
        }

        // Fetch user profile from Firestore or cache
        async function getUserProfile(userId) {
            if (userProfilesCache[userId]) {
                return userProfilesCache[userId];
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    userProfilesCache[userId] = userDocSnap.data();
                    return userProfilesCache[userId];
                } else {
                    console.warn(`User profile not found for ID: ${userId}.`);
                    return { uid: userId, displayName: "Unknown User", photoURL: "" };
                }
            } catch (error) {
                console.error(`Error fetching user profile for ID ${userId}:`, error);
                return { uid: userId, displayName: "Error User", photoURL: "" };
            }
        }


        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                console.log("Firebase app initialized successfully.");

                // If running in Canvas with initialAuthToken, try custom token sign-in first
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token (Canvas environment).");
                    } catch (tokenError) {
                        console.warn("Custom token sign-in failed, falling back to anonymous/Google if already signed in.", tokenError);
                        // If custom token fails, let onAuthStateChanged handle the initial user state
                    }
                } else if (!auth.currentUser) {
                    // For local runs without Canvas token, try anonymous sign-in by default
                    // or wait for explicit Google sign-in
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously (local/initial).");
                }


                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        // Fetch the actual user profile for display name and PFP
                        const profile = await getUserProfile(user.uid);
                        currentUserDisplayName = profile.displayName || user.displayName || 'Guest';
                        currentUserPhotoURL = profile.photoURL || user.photoURL || '';

                        userIdValueDisplay.textContent = currentUserDisplayName; // Show display name
                        // Optional: Display PFP in the footer if you add an img tag there
                        // console.log("Current user profile:", { uid: currentUserId, displayName: currentUserDisplayName, photoURL: currentUserPhotoURL });


                        console.log("Firebase user signed in:", currentUserId, "Name:", currentUserDisplayName);
                        getUserLocation().then(() => {
                            setupPostListener(); // Only set up post listener after auth and location
                        }).catch(err => console.error("Error getting location after auth:", err));

                        // Hide Google Sign-in button if already signed in
                        googleSignInBtn.style.display = 'none';

                    } else {
                        currentUserId = null;
                        currentUserDisplayName = "Guest";
                        currentUserPhotoURL = "";
                        userIdValueDisplay.textContent = 'Not signed in';
                        console.log("No user signed in.");
                        showMessageBox("Please sign in to post and see personalized content.");
                        // Show Google Sign-in button if not signed in
                        googleSignInBtn.style.display = 'flex'; // Use flex to maintain styling
                    }
                });

            } catch (error) {
                console.error("Critical Error during Firebase initialization or sign-in:", error.code, error.message, error);
                showMessageBox(`Failed to initialize the app: ${error.message}. Please check console for details.`);
            }
        }

        // Function to display posts in the UI (now with author's display name and PFP)
        function displayPosts(postsData) {
            postsGrid.innerHTML = ''; // Clear existing posts
            let foundNearby = false;

            console.log(`Displaying posts. User location available: ${!!userLocation}. Total posts fetched: ${postsData.length}`); // Debug log

            if (!userLocation) {
                noPostsMessage.textContent = "Your location is required to filter local posts. Please enable location services in your browser.";
                noPostsMessage.style.display = 'block';
                console.warn("Display Posts: User location not available, cannot filter posts."); // Debug log
                return;
            }
            
            if (postsData.length === 0) {
                 noPostsMessage.textContent = "No posts found. Be the first to post!";
                 noPostsMessage.style.display = 'block';
                 console.log("Display Posts: No posts fetched from Firestore at all.");
                 return;
            }

            postsData.forEach(async (post) => { // Use async here because we fetch user profile
                if (post.location && post.location.latitude && post.location.longitude) {
                    const distance = calculateDistance(
                        userLocation.latitude, userLocation.longitude,
                        post.location.latitude, post.location.longitude
                    );
                    
                    console.log(`Post ID: ${post.id}, Post Location: (${post.location.latitude}, ${post.location.longitude}), Distance: ${distance.toFixed(2)}m`);

                    if (distance <= 500) { // Within 500 meters
                        foundNearby = true;
                        const postSquare = document.createElement('div');
                        postSquare.className = 'post-square';

                        const timestamp = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'N/A';
                        const distanceDisplay = distance < 1 ? '<1m' : `${distance.toFixed(0)}m`;

                        let linkPreviewHtml = '';
                        if (post.linkUrl) {
                            const domain = getDomainFromUrl(post.linkUrl);
                            const faviconUrl = domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=64` : '';
                            linkPreviewHtml = `
                                <div class="link-preview-image">
                                    <a href="${post.linkUrl}" target="_blank" rel="noopener noreferrer">
                                        <img src="${faviconUrl}" onerror="this.onerror=null;this.src='https://placehold.co/64x64/dddddd/aaaaaa?text=Link';" alt="Link preview">
                                    </a>
                                </div>
                            `;
                        }
                        
                        // Fetch author's profile for display
                        const authorProfile = await getUserProfile(post.userId);
                        const authorName = authorProfile.displayName || post.userId.substring(0, 5) + '...';
                        const authorPhoto = authorProfile.photoURL || 'https://placehold.co/32x32/cccccc/333333?text=ðŸ‘¤';


                        const summarizeButton = `<button class="summarize-btn" data-post-text="${encodeURIComponent(post.text)}">âœ¨ Summarize</button>`;


                        postSquare.innerHTML = `
                            ${linkPreviewHtml}
                            <div class="text-content">${post.text}</div>
                            <div class="meta-info">
                                <span class="flex items-center gap-1">
                                    <img src="${authorPhoto}" class="w-4 h-4 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=ðŸ‘¤';" alt="Profile Picture">
                                    By: <span class="font-medium">${authorName}</span>
                                </span>
                                <span>${timestamp}</span>
                                <span>${distanceDisplay} away</span>
                                ${summarizeButton}
                            </div>
                        `;
                        postsGrid.appendChild(postSquare);
                    } else {
                        console.log(`Post ID: ${post.id} is too far away (${distance.toFixed(2)}m), skipping.`);
                    }
                } else {
                    console.warn(`Post ID: ${post.id} is missing location data, skipping.`);
                }
            });
            // Attach event listeners after all posts are added to DOM
            document.querySelectorAll('.summarize-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const postText = decodeURIComponent(event.target.dataset.postText);
                    showSummaryModal(postText);
                });
            });


            if (!foundNearby && postsData.length > 0) {
                noPostsMessage.textContent = "No posts found within 500 meters of your current location. Try posting one from your current spot!";
                noPostsMessage.style.display = 'block';
                console.log("Display Posts: No nearby posts found despite fetching some posts.");
            } else if (foundNearby) {
                noPostsMessage.style.display = 'none';
                console.log("Display Posts: Posts successfully displayed.");
            }
        }

        // Set up real-time listener for posts from Firestore
        function setupPostListener() {
            if (!db) {
                console.error("Firestore not initialized, cannot set up listener.");
                showMessageBox("Database not ready. Cannot load posts. Check console.");
                return;
            }

            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
            console.log(`Setting up Firestore listener for path: artifacts/${appId}/public/data/posts`);

            const q = query(postsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                console.log("Firestore Snapshot: Fetched posts:", posts);
                displayPosts(posts);
            }, (error) => {
                console.error("Error fetching posts:", error.code, error.message, error);
                showMessageBox(`Failed to load posts: ${error.message}. Please check your Firestore security rules and network connection.`);
            });
        }

        // Function to call Gemini API for hashtag generation
        async function generateHashtags() {
            const postContent = postContentInput.value.trim();

            if (!postContent) {
                showMessageBox("Please write some content in your post to generate hashtags.");
                return;
            }

            hashtagLoadingSpinner.classList.add('show');
            generateHashtagsBtn.disabled = true;

            try {
                const prompt = `You are a social media assistant. Generate 3-5 relevant and popular hashtags for the following social media post content. Provide only the hashtags, separated by spaces. Do not include any other text.
Post: '${postContent}'`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const hashtags = result.candidates[0].content.parts[0].text.trim();
                    if (hashtags) {
                        postContentInput.value = postContentInput.value + "\n\n" + hashtags;
                    } else {
                        showMessageBox("No hashtags generated. Try rephrasing your post.");
                    }
                } else {
                    showMessageBox("Could not generate hashtags. Unexpected API response.");
                    console.error("Unexpected API response structure:", result);
                }

            } catch (error) {
                console.error("Error generating hashtags:", error);
                showMessageBox(`Failed to generate hashtags: ${error.message}.`);
            } finally {
                hashtagLoadingSpinner.classList.remove('show');
                generateHashtagsBtn.disabled = false;
            }
        }

        // Function to call Gemini API for generating a full post
        async function generateAIPost() {
            const aiPrompt = aiPromptInput.value.trim();

            if (!aiPrompt) {
                showMessageBox("Please enter a topic or prompt for the AI to generate a post.");
                return;
            }

            aiPostLoadingSpinner.classList.add('show');
            generateAiPostBtn.disabled = true;

            try {
                const prompt = `Write a short, engaging social media post (around 50-100 words) about the following topic. Do not include hashtags in your response.
Topic: '${aiPrompt}'`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text.trim();
                    aiGeneratedContent.value = generatedText;
                } else {
                    showMessageBox("Could not generate post. Unexpected API response.");
                    console.error("Unexpected API response structure:", result);
                }

            } catch (error) {
                console.error("Error generating AI post:", error);
                showMessageBox(`Failed to generate post: ${error.message}.`);
            } finally {
                aiPostLoadingSpinner.classList.remove('show');
                generateAiPostBtn.disabled = false;
            }
        }

        // Function to call Gemini API to summarize a post
        async function generatePostSummary(postText) {
            summaryModal.classList.remove('hidden');
            summaryContent.textContent = 'Generating summary...';
            summaryLoadingSpinner.classList.add('show');

            try {
                const prompt = `Summarize the following social media post in 1-2 concise sentences.
Post: '${postText}'`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const summary = result.candidates[0].content.parts[0].text.trim();
                    summaryContent.textContent = summary;
                } else {
                    summaryContent.textContent = "Could not generate summary. Unexpected API response.";
                    console.error("Unexpected API response structure for summary:", result);
                }

            } catch (error) {
                summaryContent.textContent = `Failed to generate summary: ${error.message}.`;
                console.error("Error generating summary:", error);
            } finally {
                summaryLoadingSpinner.classList.remove('show');
            }
        }

        // Function to show the summary modal
        function showSummaryModal(postText) {
            generatePostSummary(postText);
        }

        // Function to fetch and display unique user profiles
        async function fetchAndDisplayUserProfiles() {
            profilesList.innerHTML = '<p class="text-gray-500 text-center">Loading user profiles...</p>';
            try {
                if (!db) {
                    console.error("Firestore not initialized for profiles.");
                    profilesList.innerHTML = '<p class="text-red-500 text-center">Error: Database not ready.</p>';
                    return;
                }

                const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
                const querySnapshot = await getDocs(query(usersCollectionRef));
                
                profilesList.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    profilesList.innerHTML = '<p class="text-gray-500 text-center">No user profiles found yet. Sign in with Google to add yours!</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        const profileItem = document.createElement('div');
                        profileItem.className = 'profile-item';
                        profileItem.innerHTML = `
                            <img src="${userData.photoURL || 'https://placehold.co/32x32/cccccc/333333?text=ðŸ‘¤'}" class="w-8 h-8 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=ðŸ‘¤';" alt="Profile Picture">
                            <span class="font-medium">${userData.displayName || userData.uid.substring(0, 10) + '...'}</span>
                        `;
                        profilesList.appendChild(profileItem);
                        userProfilesCache[userData.uid] = userData; // Cache the profile
                    });
                }

            } catch (error) {
                console.error("Error fetching user profiles:", error);
                profilesList.innerHTML = `<p class="text-red-500 text-center">Failed to load profiles: ${error.message}.</p>`;
                showMessageBox(`Failed to load user profiles: ${error.message}`);
            }
        }


        // Event listener for the Post button
        postButton.addEventListener('click', async () => {
            const postContent = postContentInput.value.trim();
            const postLink = postLinkInput.value.trim();

            if (!postContent && !postLink) {
                showMessageBox("Post content or a link must be provided.");
                return;
            }
            if (!currentUserId) {
                showMessageBox("You must be signed in to post. Please sign in with Google.");
                return;
            }
            if (!userLocation) {
                showMessageBox("Your location is still being determined or could not be found. Please wait or ensure location services are enabled.");
                await getUserLocation();
                if (!userLocation) {
                    showMessageBox("Could not get your location. Post cancelled.");
                    return;
                }
            }

            try {
                const postData = {
                    userId: currentUserId,
                    text: postContent,
                    timestamp: Date.now(),
                    location: userLocation
                };

                if (postLink) {
                    postData.linkUrl = postLink;
                }

                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), postData);
                postContentInput.value = '';
                postLinkInput.value = '';
                postModal.classList.add('hidden');
            } catch (error) {
                console.error("Error adding document: ", error.code, error.message, error);
                showMessageBox(`Failed to add post: ${error.message}. Check Firestore permissions.`);
            }
        });

        // Event listeners for post creation modal toggle
        addPostBtn.addEventListener('click', () => {
            postModal.classList.remove('hidden');
            locationStatus.textContent = 'Getting location for post...';
            locationLoadingSpinner.classList.add('show');
            getUserLocation();
        });
        closeModalBtn.addEventListener('click', () => {
            postModal.classList.add('hidden');
            postContentInput.value = '';
            postLinkInput.value = '';
        });

        // Event listener for the new Generate Hashtags button
        generateHashtagsBtn.addEventListener('click', generateHashtags);

        // Event listener for the AI Post button
        aiPostBtn.addEventListener('click', () => {
            aiPostModal.classList.remove('hidden');
            aiPromptInput.value = '';
            aiGeneratedContent.value = '';
        });
        // Event listener for closing AI Post modal
        closeAiModalBtn.addEventListener('click', () => {
            aiPostModal.classList.add('hidden');
        });
        // Event listener for generating AI post
        generateAiPostBtn.addEventListener('click', generateAIPost);
        // Event listener for using AI generated post
        useAiPostBtn.addEventListener('click', () => {
            if (aiGeneratedContent.value.trim()) {
                postContentInput.value = aiGeneratedContent.value.trim();
                aiPostModal.classList.add('hidden');
                postModal.classList.remove('hidden');
                postLinkInput.value = '';
            } else {
                showMessageBox("No AI post generated to use.");
            }
        });

        // Event listener for closing Summary modal
        closeSummaryModalBtn.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
            summaryContent.textContent = ''; // Clear content for next time
        });

        // Event listener for the new Profiles button
        profilesBtn.addEventListener('click', () => {
            profilesModal.classList.remove('hidden');
            fetchAndDisplayUserProfiles(); // Fetch and display profiles when modal opens
        });
        // Event listener for closing Profiles modal
        closeProfilesModalBtn.addEventListener('click', () => {
            profilesModal.classList.add('hidden');
        });

        // New: Event listener for Google Sign-in button
        googleSignInBtn.addEventListener('click', signInWithGoogle);

        // Initialize the app when the page loads
        initializeFirebase();
    </script>
</body>
</html>
