<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Social Feed</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .post-input-section, .post-feed-section {
            padding: 16px;
            background-color: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .post-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        .post-card:last-child {
            margin-bottom: 0;
        }
        .post-text {
            font-size: 1rem;
            line-height: 1.5;
            color: #374151;
            margin-bottom: 8px;
            word-wrap: break-word; /* Ensures long words break and wrap */
        }
        .post-meta {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allows meta info to wrap on small screens */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            display: none; /* Hidden by default */
            font-family: 'Inter', sans-serif;
            max-width: 90%;
        }
        .message-box button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1rem;
        }
        .message-box button:hover {
            background-color: #45a049;
        }
        .message-box.show {
            display: block;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none; /* Hidden by default */
        }
        .loading-spinner.show {
            display: block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            .post-input-section, .post-feed-section {
                padding: 12px;
            }
            .post-card {
                padding: 12px;
            }
            .post-text {
                font-size: 0.95rem;
            }
            .post-meta {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center">
    <div class="container">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-gray-800 text-center flex-grow">Local Buzz</h1>
        </div>


        <!-- User Info Section -->
        <div class="user-info text-center text-sm text-gray-600 mb-4">
            <p>Your User ID: <span id="user-id-display" class="font-semibold text-gray-700">Loading...</span></p>
        </div>

        <!-- Create Post Section -->
        <div class="post-input-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Create a New Post</h2>
            <textarea id="post-content" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y" placeholder="What's happening in your neighborhood?"></textarea>
            <button id="post-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                Post
            </button>
            <div id="location-loading-spinner" class="loading-spinner mt-4"></div>
            <p id="location-status" class="text-sm text-gray-500 text-center mt-2">Getting your location...</p>
        </div>

        <!-- Post Feed Section -->
        <div class="post-feed-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Local Posts (within 500m)</h2>
            <div id="posts-container">
                <!-- Posts will be loaded here -->
                <p id="no-posts-message" class="text-gray-500 text-center">No posts found nearby. Be the first to post!</p>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="message-box">
        <p id="messageBoxContent"></p>
        <button onclick="document.getElementById('messageBox').classList.remove('show');">OK</button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the environment or replaced locally)
        // !!! IMPORTANT: If running locally, make sure your Firebase project's anonymous auth
        // is enabled and Firestore rules allow read/write for 'artifacts/{your_app_id}/public/data/posts'
        // where {your_app_id} will be 'default-app-id' if running outside Canvas.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAE37qdlDBYSUhumSO6jTA985V81DN9iA8", // YOUR_API_KEY
                authDomain: "lowk-be8e0.firebaseapp.com", // YOUR_AUTH_DOMAIN
                projectId: "lowk-be8e0", // YOUR_PROJECT_ID
                storageBucket: "lowk-be8e0.firebasestorage.app", // YOUR_STORAGE_BUCKET
                messagingSenderId: "244867743683", // YOUR_MESSAGING_SENDER_ID
                appId: "1:244867743683:web:1b11ac7b94462ef5314776" // YOUR_APP_ID
              };

        // For local testing, 'appId' will be 'default-app-id'. In Canvas, it's provided.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Log a warning if the Canvas-provided config is not found (i.e., running locally)
        if (typeof __firebase_config === 'undefined') {
            console.warn(`Local run detected. Using provided firebaseConfig. Ensure 'Anonymous' auth is enabled in Firebase and Firestore rules allow read/write for 'artifacts/${appId}/public/data/posts'.`);
        }

        // Initialize Firebase variables
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let userLocation = null; // Stores { latitude, longitude } of the current user

        // Get references to HTML elements
        const postContentInput = document.getElementById('post-content');
        const postButton = document.getElementById('post-button');
        const postsContainer = document.getElementById('posts-container');
        const noPostsMessage = document.getElementById('no-posts-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const locationStatus = document.getElementById('location-status');
        const locationLoadingSpinner = document.getElementById('location-loading-spinner');
        const messageBox = document.getElementById('messageBox');
        const messageBoxContent = document.getElementById('messageBoxContent');


        // Function to show a custom message box instead of alert()
        function showMessageBox(message) {
            messageBoxContent.textContent = message;
            messageBox.classList.add('show');
        }

        // Haversine formula to calculate distance between two lat/lon points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in metres
            const φ1 = lat1 * Math.PI / 180; // latitude in radians
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180; // delta latitude in radians
            const Δλ = (lon2 - lon1) * Math.PI / 180; // delta longitude in radians

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // distance in metres
            return distance;
        }

        // Get user's current location using Geolocation API
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                locationLoadingSpinner.classList.add('show');
                locationStatus.textContent = 'Getting your location...';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };
                            locationLoadingSpinner.classList.remove('show');
                            locationStatus.textContent = `Location: ${userLocation.latitude.toFixed(4)}, ${userLocation.longitude.toFixed(4)}`;
                            resolve(userLocation);
                        },
                        (error) => {
                            locationLoadingSpinner.classList.remove('show');
                            let errorMessage = 'Unable to retrieve your location.';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "Location access denied. Please allow location access in your browser settings.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Location information is unavailable. Try again later.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "Request to get user location timed out. Check your network or GPS.";
                                    break;
                                default:
                                    errorMessage = `An unknown error occurred: ${error.message}`;
                                    break;
                            }
                            locationStatus.textContent = errorMessage;
                            console.error("Geolocation Error:", error);
                            showMessageBox(errorMessage);
                            reject(new Error(errorMessage));
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } // Options for geolocation
                    );
                } else {
                    const errorMessage = "Geolocation is not supported by your browser. Please use a modern browser.";
                    locationLoadingSpinner.classList.remove('show');
                    locationStatus.textContent = errorMessage;
                    showMessageBox(errorMessage);
                    reject(new Error(errorMessage));
                }
            });
        }

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig); // Initialize Firebase app
                db = getFirestore(app);             // Get Firestore instance
                auth = getAuth(app);                 // Get Auth instance

                console.log("Firebase app initialized successfully.");
                console.log("Firebase DB instance:", db);
                console.log("Firebase Auth instance:", auth);


                // Attempt to sign in with custom token if provided (Canvas environment)
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } catch (tokenError) {
                        console.warn("Custom token sign-in failed, attempting anonymous sign-in.", tokenError);
                        // Fallback to anonymous sign-in if custom token fails or is not available
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (fallback).");
                    }
                } else {
                    // Sign in anonymously if no custom token is provided (local run or standard setup)
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId.substring(0, 8) + '...'; // Display truncated ID
                        console.log("Firebase user signed in:", currentUserId);
                        // Once authenticated, get location and then start listening for posts
                        getUserLocation().then(() => {
                            setupPostListener();
                        }).catch(err => console.error("Error getting location after auth:", err));
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = 'Not authenticated';
                        console.log("No user signed in.");
                        showMessageBox("Authentication failed. Please check console for details.");
                    }
                });

            } catch (error) {
                console.error("Critical Error during Firebase initialization or sign-in:", error.code, error.message, error);
                showMessageBox(`Failed to initialize the app: ${error.message}. Please check console for details.`);
            }
        }

        // Function to display posts in the UI
        function displayPosts(postsData) {
            postsContainer.innerHTML = ''; // Clear existing posts
            let foundNearby = false;

            if (userLocation && postsData.length > 0) {
                // Filter and display posts within 500 meters
                postsData.forEach(post => {
                    if (post.location && post.location.latitude && post.location.longitude) {
                        const distance = calculateDistance(
                            userLocation.latitude, userLocation.longitude,
                            post.location.latitude, post.location.longitude
                        );

                        if (distance <= 500) { // Within 500 meters
                            foundNearby = true;
                            const postCard = document.createElement('div');
                            postCard.className = 'post-card';
                            // Format timestamp for display
                            const timestamp = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'N/A';
                            // Format distance for display
                            const distanceDisplay = distance < 1 ? '<1 meter' : `${distance.toFixed(0)} meters`;

                            postCard.innerHTML = `
                                <p class="post-text">${post.text}</p>
                                <div class="post-meta">
                                    <span>Posted by: <span class="font-medium">${post.userId.substring(0, 8)}...</span></span>
                                    <span>${timestamp}</span>
                                    <span>${distanceDisplay} away</span>
                                </div>
                            `;
                            postsContainer.appendChild(postCard);
                        }
                    }
                });
            } else if (!userLocation) {
                noPostsMessage.textContent = "Your location is required to filter local posts. Please enable location services.";
                noPostsMessage.style.display = 'block';
                return;
            }

            if (!foundNearby && postsData.length > 0) {
                noPostsMessage.textContent = "No posts found within 500 meters of your current location.";
                noPostsMessage.style.display = 'block'; // Show message if no posts found nearby
            } else if (postsData.length === 0) {
                noPostsMessage.textContent = "No posts found. Be the first to post!";
                noPostsMessage.style.display = 'block';
            } else {
                noPostsMessage.style.display = 'none'; // Hide message if posts are found
            }
        }

        // Set up real-time listener for posts from Firestore
        function setupPostListener() {
            if (!db) {
                console.error("Firestore not initialized, cannot set up listener. DB object is null or undefined.");
                showMessageBox("Database not ready. Cannot load posts. Check console.");
                return;
            }

            // Collection reference for public data under the app ID
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);

            // Use onSnapshot to listen for real-time updates to the posts collection
            const q = query(postsCollectionRef); // Fetch all, then filter and sort in JS

            onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                // Sort posts by timestamp in descending order (most recent first) in memory
                posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                displayPosts(posts); // Update the UI with the filtered and sorted posts
            }, (error) => {
                console.error("Error fetching posts:", error.code, error.message, error);
                showMessageBox(`Failed to load posts: ${error.message}. Please check your Firestore security rules and network connection.`);
            });
        }

        // Event listener for the Post button
        postButton.addEventListener('click', async () => {
            const postContent = postContentInput.value.trim();

            if (!postContent) {
                showMessageBox("Post content cannot be empty.");
                return;
            }
            if (!currentUserId) {
                showMessageBox("You must be authenticated to post. Please try refreshing the page.");
                return;
            }
            if (!userLocation) {
                showMessageBox("Your location is still being determined or could not be found. Please wait or ensure location services are enabled.");
                await getUserLocation(); // Try to get location again
                if (!userLocation) { // If still no location after retry, stop here
                    showMessageBox("Could not get your location. Post cancelled.");
                    return;
                }
            }

            try {
                // Add the new post document to Firestore
                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), {
                    userId: currentUserId,
                    text: postContent,
                    timestamp: Date.now(), // Store current time as Unix timestamp
                    location: userLocation // Store current user's location (latitude, longitude)
                });
                postContentInput.value = ''; // Clear the input field after successful post
            } catch (error) {
                console.error("Error adding document: ", error.code, error.message, error);
                showMessageBox(`Failed to add post: ${error.message}. Check Firestore permissions.`);
            }
        });

        // Initialize the app when the page loads
        initializeFirebase();
    </script>
</body>
</html>
